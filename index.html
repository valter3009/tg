<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>IDTrade Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
    :root {
        --tg-theme-bg-color: #1a1b1e;
        --tg-theme-secondary-bg-color: #2c2e33;
        --tg-theme-text-color: #ffffff;
        --tg-theme-hint-color: #9ca3af;
        --tg-theme-button-color: #3b82f6;
        --tg-theme-button-text-color: #ffffff;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --border-radius: 12px;
        --safe-area-inset-bottom: env(safe-area-inset-bottom);
        --viewport-height: 100vh;
        --keyboard-height: 0px;
    }

    * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        margin: 0;
        padding: 0;
    }

    html {
        height: 100%;
        overflow: hidden;
        position: fixed;
        width: 100%;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #2c2e33;
        color: var(--tg-theme-text-color);
        height: 100%;
        overflow: hidden;
        position: fixed;
        width: 100%;
        padding-bottom: var(--safe-area-inset-bottom);
    }

    .app-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
    }

    .app-container {
        flex: 1;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .scroll-container {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        position: relative;
        padding-bottom: calc(var(--bottom-offset, 0px) + 16px);
    }

    /* Остальные стили остаются теми же, за исключением .bottom-panel */
    
    .bottom-panel {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 16px;
        padding-bottom: calc(16px + var(--safe-area-inset-bottom));
        transform: translateZ(0);
        will-change: transform;
        z-index: 1000;
    }

    [data-keyboard="visible"] .bottom-panel {
        position: fixed;
    }

    @supports (padding: max(0px)) {
        .bottom-panel {
            padding-bottom: max(16px, calc(16px + var(--safe-area-inset-bottom)));
        }
    }

    /* Стили для предотвращения взаимодействия во время анимаций */
    .disable-interactions {
        pointer-events: none;
    }

    /* Остальные стили без изменений */
    </style>
</head>
<body>
    <div class="app-wrapper">
        <div class="app-container">
            <div class="scroll-container">
                <div id="pairs-screen" class="screen active">
                    <!-- Содержимое то же самое -->
                </div>

                <div id="equations-screen" class="screen">
                    <!-- Содержимое то же самое -->
                </div>
            </div>
        </div>

        <div class="bottom-panel" id="bottom-panel">
            <!-- Содержимое то же самое -->
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let pairs = {};
        let equations = {};
        let equationCount = 0;
        
        // Новая система управления клавиатурой и viewport
        const KeyboardManager = {
            isKeyboardVisible: false,
            keyboardHeight: 0,
            initialViewportHeight: window.innerHeight,
            safeAreaInset: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-bottom')) || 0,
            
            init() {
                if ('visualViewport' in window) {
                    window.visualViewport.addEventListener('resize', this.handleViewportChange.bind(this));
                    window.visualViewport.addEventListener('scroll', this.handleViewportChange.bind(this));
                }

                window.addEventListener('resize', this.handleWindowResize.bind(this));
                
                // Обработчики для инпутов
                document.querySelectorAll('input').forEach(input => {
                    input.addEventListener('focus', this.handleInputFocus.bind(this));
                    input.addEventListener('blur', this.handleInputBlur.bind(this));
                });
            },

            handleViewportChange(event) {
                if (!window.visualViewport) return;

                requestAnimationFrame(() => {
                    const viewport = window.visualViewport;
                    const newKeyboardHeight = Math.max(0, this.initialViewportHeight - viewport.height);
                    
                    if (newKeyboardHeight > 0) {
                        this.showKeyboard(newKeyboardHeight);
                    } else {
                        this.hideKeyboard();
                    }
                });
            },

            handleWindowResize() {
                // Обновляем базовую высоту только если клавиатура скрыта
                if (!this.isKeyboardVisible) {
                    this.initialViewportHeight = window.innerHeight;
                }
            },

            handleInputFocus(event) {
                document.body.setAttribute('data-keyboard', 'visible');
                // Прокручиваем к активному элементу с задержкой
                setTimeout(() => {
                    event.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            },

            handleInputBlur(event) {
                // Проверяем, что следующий активный элемент не инпут
                setTimeout(() => {
                    if (!document.activeElement.matches('input')) {
                        document.body.removeAttribute('data-keyboard');
                        this.hideKeyboard();
                    }
                }, 100);
            },

            showKeyboard(height) {
                this.isKeyboardVisible = true;
                this.keyboardHeight = height;

                const bottomPanel = document.getElementById('bottom-panel');
                document.documentElement.style.setProperty('--keyboard-height', `${height}px`);
                bottomPanel.style.transform = `translateY(-${height}px)`;

                // Устанавливаем нижний отступ для контента
                document.documentElement.style.setProperty('--bottom-offset', `${bottomPanel.offsetHeight}px`);
                
                // Добавляем класс для блокировки взаимодействия во время анимации
                document.body.classList.add('disable-interactions');
                setTimeout(() => {
                    document.body.classList.remove('disable-interactions');
                }, 300);
            },

            hideKeyboard() {
                if (!this.isKeyboardVisible) return;

                this.isKeyboardVisible = false;
                this.keyboardHeight = 0;

                const bottomPanel = document.getElementById('bottom-panel');
                document.documentElement.style.setProperty('--keyboard-height', '0px');
                bottomPanel.style.transform = 'translateY(0)';

                // Сбрасываем нижний отступ
                document.documentElement.style.setProperty('--bottom-offset', `${bottomPanel.offsetHeight}px`);
                
                // Добавляем класс для блокировки взаимодействия во время анимации
                document.body.classList.add('disable-interactions');
                setTimeout(() => {
                    document.body.classList.remove('disable-interactions');
                }, 300);

                // Прокручиваем контент наверх с задержкой
                setTimeout(() => {
                    window.scrollTo(0, 0);
                }, 50);
            }
        };

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            tg.expand();
            KeyboardManager.init();
            
            // Загрузка тестовых данных...
            // Остальной код инициализации остается без изменений
        });

        // Предотвращение скролла на iOS
        document.addEventListener('touchmove', (e) => {
            if (KeyboardManager.isKeyboardVisible && !e.target.closest('.scroll-container')) {
                e.preventDefault();
            }
        }, { passive: false });

        // Остальной функционал остается тем же
        // Функции addPair, removePair, addToEquation и т.д. остаются без изменений
    </script>
</body>
</html>
