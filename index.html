<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–∏–¥–µ–æ—á–∞—Ç</title>
    <script src="https://meet.jit.si/external_api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: white;
            font-size: 18px;
            font-weight: 600;
        }

        .end-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(255, 71, 87, 0.3);
        }

        .end-btn:hover {
            background: #ff3742;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
        }

        .end-btn:active {
            transform: translateY(0);
        }

        .video-container {
            flex: 1;
            position: relative;
            background: #000;
        }

        #jitsi-container {
            width: 100%;
            height: 100%;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            z-index: 10;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            background: rgba(255, 71, 87, 0.9);
            padding: 20px;
            border-radius: 10px;
            max-width: 300px;
            z-index: 20;
        }

        .error h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .error p {
            font-size: 14px;
            opacity: 0.9;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #2ed573;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 768px) {
            .header {
                padding: 12px 15px;
            }
            
            .header h1 {
                font-size: 16px;
            }
            
            .end-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span class="status-indicator"></span>
                –í–∏–¥–µ–æ—á–∞—Ç
            </h1>
            <button class="end-btn" onclick="endCall()">
                üîö –ó–∞–≤–µ—Ä—à–∏—Ç—å
            </button>
        </div>
        
        <div class="video-container">
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–∏–¥–µ–æ—á–∞—Ç—É...</p>
            </div>
            <div id="jitsi-container"></div>
        </div>
    </div>

    <script>
        let api = null;
        let roomId = null;
        let isConnected = false;

        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function generateUsername() {
            const adjectives = ['Cool', 'Smart', 'Happy', 'Bright', 'Kind', 'Swift'];
            const nouns = ['User', 'Guest', 'Friend', 'Buddy', 'Mate', 'Pal'];
            const adjective = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            const number = Math.floor(Math.random() * 100);
            return `${adjective}${noun}${number}`;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            const loading = document.getElementById('loading');
            loading.innerHTML = `
                <div class="error">
                    <h3>‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Jitsi Meet
        function initJitsi() {
            roomId = getUrlParameter('room');
            
            if (!roomId) {
                showError('–ù–µ —É–∫–∞–∑–∞–Ω ID –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }

            const domain = 'meet.jit.si';
            const options = {
                roomName: `VideoChat_${roomId}`,
                width: '100%',
                height: '100%',
                parentNode: document.querySelector('#jitsi-container'),
                userInfo: {
                    displayName: generateUsername()
                },
                configOverwrite: {
                    startWithAudioMuted: false,
                    startWithVideoMuted: false,
                    enableWelcomePage: false,
                    prejoinPageEnabled: false,
                    disableModeratorIndicator: true,
                    startScreenSharing: false,
                    enableEmailInStats: false,
                    enableClosePage: false
                },
                interfaceConfigOverwrite: {
                    DISABLE_JOIN_LEAVE_NOTIFICATIONS: true,
                    DISABLE_PRESENCE_STATUS: true,
                    HIDE_INVITE_MORE_HEADER: true,
                    SHOW_JITSI_WATERMARK: false,
                    SHOW_WATERMARK_FOR_GUESTS: false,
                    SHOW_POWERED_BY: false,
                    TOOLBAR_BUTTONS: [
                        'microphone', 'camera', 'hangup',
                        'settings', 'videoquality', 'filmstrip',
                        'tileview', 'shortcuts'
                    ],
                    SETTINGS_SECTIONS: [
                        'devices', 'language', 'moderator', 'profile'
                    ]
                }
            };

            try {
                api = new JitsiMeetExternalAPI(domain, options);
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                api.addEventListener('videoConferenceJoined', () => {
                    console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω –∫ –≤–∏–¥–µ–æ—á–∞—Ç—É');
                    document.getElementById('loading').style.display = 'none';
                    isConnected = true;
                });

                api.addEventListener('videoConferenceLeft', () => {
                    console.log('–ü–æ–∫–∏–Ω—É–ª –≤–∏–¥–µ–æ—á–∞—Ç');
                    isConnected = false;
                    endCall();
                });

                api.addEventListener('readyToClose', () => {
                    console.log('–ì–æ—Ç–æ–≤ –∫ –∑–∞–∫—Ä—ã—Ç–∏—é');
                    endCall();
                });

                // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
                setTimeout(() => {
                    const loading = document.getElementById('loading');
                    if (loading.style.display !== 'none') {
                        loading.style.display = 'none';
                    }
                }, 10000);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Jitsi:', error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –≤–∏–¥–µ–æ—á–∞—Ç—É');
            }
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
        function endCall() {
            if (api) {
                try {
                    api.dispose();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ Jitsi:', error);
                }
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –±–æ—Ç–∞
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.close();
            } else {
                // Fallback –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ Telegram
                window.close();
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –≤ –±—Ä–∞—É–∑–µ—Ä–µ
        window.addEventListener('beforeunload', () => {
            if (api) {
                api.dispose();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è WebApp
        window.addEventListener('beforeunload', (event) => {
            if (isConnected) {
                event.preventDefault();
                event.returnValue = '';
                return '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å –≤–∏–¥–µ–æ—á–∞—Ç?';
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–≤–µ—Ç–æ–≤–æ–π —Å—Ö–µ–º—ã
            tg.setHeaderColor('#667eea');
            tg.setBackgroundColor('#667eea');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
            tg.BackButton.show();
            tg.BackButton.onClick(endCall);
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ UX
            setTimeout(initJitsi, 500);
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ JavaScript
        window.addEventListener('error', (event) => {
            console.error('JavaScript error:', event.error);
            showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
        });
    </script>
</body>
</html>
