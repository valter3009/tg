<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Погодный виджет</title>
    <!-- Telegram WebApp Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
    
        ym(101522448, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true
        });
        
        function getParameterByName(name) {
            var url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
        
        window.onload = function() {
            var source = getParameterByName('source') || 'unknown';
            var userId = getParameterByName('user_id') || 'unknown';
            
            ym(101522448, 'reachGoal', 'webapp_open', {
                source: source,
                user_id: userId
            });
            
            // Инициализация Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                // Отключаем возможность закрытия приложения свайпом
                // Устанавливаем параметры viewport для запрета закрытия приложения свайпом
                window.Telegram.WebApp.setViewportSettings({
                    can_be_closed: true,                // Приложение может быть закрыто (кнопкой)
                    disable_swipe_to_close: true,       // Отключаем закрытие свайпом
                    disable_pulling_to_refresh: true    // Отключаем обновление страницы свайпом
                });
                
                // Адаптируем тему приложения
                const tgColorScheme = window.Telegram.WebApp.colorScheme;
                if (tgColorScheme === 'dark') {
                    document.body.classList.add('dark-theme');
                }
                
                // Включаем расширение на весь экран
                window.Telegram.WebApp.expand();
            }
        };
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/101522448" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
    <style>
        html, body {
            overscroll-behavior-y: none; /* Предотвращает свайп браузера для обновления страницы */
            touch-action: pan-x pan-y; /* Разрешаем стандартную прокрутку, но контролируем её в JS */
        }
        body {font-family:Arial,sans-serif; margin:0; padding:10px; background-color:#0F4778; overflow-x:hidden; color:#eee;}
        .container {width:100%; max-width:500px; margin:0 auto; display:flex; flex-direction:column; align-items:center;}
        .search-container {width:100%; margin-bottom:15px; position:relative;}
        .search-input {width:100%; padding:12px; border:1px solid #333; border-radius:8px; font-size:16px; background-color:#87CEEB; color:#333; box-sizing:border-box;}
        .search-input::placeholder {color:#444;}
        .search-results {position:absolute; width:100%; max-height:200px; overflow-y:auto; background-color:rgba(135, 206, 235, 0.6); -webkit-backdrop-filter:blur(2px); backdrop-filter:blur(2px); border:1px solid rgba(51, 51, 51, 0.5); border-radius:0 0 8px 8px; z-index:1000; display:none; box-shadow:0 4px 8px rgba(0,0,0,0.15);}
        .search-result-item {padding:10px; cursor:pointer; border-bottom:1px solid rgba(51, 51, 51, 0.3);}
        .search-result-item:hover {background-color:rgba(135, 206, 235, 0.8);}
        .city-name {font-weight:bold; color:#000; text-shadow: 0px 0px 3px rgba(255, 255, 255, 0.7);}
        .country-name {color:#222; font-size:14px; text-shadow: 0px 0px 3px rgba(255, 255, 255, 0.7);}
        .search-history {width:100%; display:none; background-color:rgba(135, 206, 235, 0.6); -webkit-backdrop-filter:blur(2px); backdrop-filter:blur(2px); border:1px solid rgba(51, 51, 51, 0.5); border-radius:0 0 8px 8px; position:absolute; top:100%; z-index:900; box-shadow:0 4px 8px rgba(0,0,0,0.15);}
        .history-item {padding:8px 10px; cursor:pointer; border-bottom:1px solid rgba(51, 51, 51, 0.3); display:flex; justify-content:space-between; align-items:center; font-size:14px; color:#000; text-shadow: 0px 0px 3px rgba(255, 255, 255, 0.7);}
        .history-item:hover {background-color:rgba(135, 206, 235, 0.95);}
        .city-info {flex-grow:1;}
        .delete-btn {color:#ff5252; cursor:pointer; padding:2px 6px; font-size:14px; border-radius:4px;}
        .delete-btn:hover {background-color:rgba(255,82,82,0.2);}
        
        /* Стили для вкладок */
        .tabs-container {
            display: flex;
            width: 100%;
            margin-bottom: 0; /* Убираем отступ снизу */
            border-radius: 8px 8px 0 0; /* Закругляем только верхние углы */
            overflow: hidden;
        }
        .tab {
            flex: 1;
            padding: 6px 0; /* Уменьшаем высоту вкладок в два раза */
            text-align: center;
            background-color: rgba(135, 206, 235, 0.4);
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            font-size: 13px; /* Уменьшаем размер шрифта для четырех вкладок */
        }
        .tab.active {
            background-color: rgba(135, 206, 235, 0.8);
            color: #003366;
        }
        .tab:first-child {
            border-top-left-radius: 8px;
        }
        .tab:last-child {
            border-top-right-radius: 8px;
        }
        
        .widget-container {
            width: 100%; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            background-color: #1e1e1e; 
            border-radius: 0 0 8px 8px; /* Закругляем только нижние углы */
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
            overflow-x: auto; /* Добавляем горизонтальную прокрутку */
            overflow-y: hidden; /* Предотвращаем вертикальную прокрутку */
            position: relative; 
            padding: 0; 
            margin-bottom: 15px;
            -webkit-overflow-scrolling: touch; /* Плавная прокрутка на iOS */
        }
        .iframe-wrapper {
            width: 100%; 
            position: relative; 
            overflow: visible; /* Позволяем содержимому выходить за пределы контейнера */
        }
        
        #weatherWidget {
            min-width: 805px; /* Фиксированная минимальная ширина для 7-дневного прогноза */
        }
        iframe {border:none; width:100%; height:620px; transform-origin:0 0; margin:0;}
        .satellite-widget-container,
        .precipitation-widget-container,
        .wind-widget-container {
            width: 100%; 
            display: none; 
            justify-content: center; 
            align-items: flex-start; 
            background-color: #1e1e1e; 
            border-radius: 0 0 8px 8px; /* Закругляем только нижние углы */
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
            overflow: hidden; 
            position: relative; 
            padding: 0; 
            margin-bottom: 15px;
        }
        .map-iframe-wrapper {width:100%; position:relative; overflow:hidden;}
        .loading {text-align:center; padding:20px; font-style:italic; color:#999;}
    </style>
</head>
<body>
    <div class="container">
        <div class="search-container">
            <input type="text" id="citySearch" class="search-input" placeholder="Введите название города..." autocomplete="off">
            <div class="search-results" id="searchResults"></div>
            <div class="search-history" id="searchHistory"></div>
        </div>
        
        <div class="tabs-container">
            <div class="tab active" id="forecastTab">Прогноз</div>
            <div class="tab" id="satelliteTab">Спутник</div>
            <div class="tab" id="precipitationTab">Осадки</div>
            <div class="tab" id="windTab">Ветер</div>
        </div>
        
        <div class="widget-container">
            <div class="iframe-wrapper">
                <iframe id="weatherWidget" src="" frameborder="0" scrolling="NO" allowtransparency="true" sandbox="allow-same-origin allow-scripts allow-popups allow-popups-to-escape-sandbox"></iframe>
            </div>
        </div>
        
        <div class="satellite-widget-container">
            <div class="iframe-wrapper">
                <iframe id="satelliteWidget" src="" frameborder="0" scrolling="NO" allowtransparency="true" sandbox="allow-same-origin allow-scripts allow-popups allow-popups-to-escape-sandbox"></iframe>
            </div>
        </div>
        
        <div class="precipitation-widget-container">
            <div class="iframe-wrapper">
                <iframe id="precipitationWidget" src="" frameborder="0" scrolling="NO" allowtransparency="true" sandbox="allow-same-origin allow-scripts allow-popups allow-popups-to-escape-sandbox"></iframe>
            </div>
        </div>
        
        <div class="wind-widget-container">
            <div class="iframe-wrapper">
                <iframe id="windWidget" src="" frameborder="0" scrolling="NO" allowtransparency="true" sandbox="allow-same-origin allow-scripts allow-popups allow-popups-to-escape-sandbox"></iframe>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = "Rn5webjm3JVIDEaK";
        const HISTORY_KEY = "weatherWidgetSearchHistory";
        const LAST_CITY_KEY = "weatherWidgetLastCity";
        const MAX_HISTORY_ITEMS = 10;
        const DEFAULT_CITY = {id:"524901", name:"Москва", country:"Россия", encoded:"%d0%9c%d0%be%d1%81%d0%ba%d0%b2%d0%b0_%d0%a0%d0%be%d1%81%d1%81%d0%b8%d1%8f"};
        let selectedCity;
        
        const loadHistory = () => JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
        const saveHistory = (history) => localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        
        function addToHistory(city) {
            let history = loadHistory();
            const idx = history.findIndex(i => i.id === city.id || (i.name === city.name && i.country === city.country));
            if (idx !== -1) history.splice(idx, 1);
            history.unshift(city);
            if (history.length > MAX_HISTORY_ITEMS) history = history.slice(0, MAX_HISTORY_ITEMS);
            saveHistory(history);
            displayHistory();
        }
        
        function removeFromHistory(index) {
            const history = loadHistory();
            history.splice(index, 1);
            saveHistory(history);
            displayHistory();
        }
        
        function displayHistory() {
            const history = loadHistory();
            const container = document.getElementById("searchHistory");
            container.innerHTML = '';
            
            if (history.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            history.forEach((city, index) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `<div class="city-info">${city.name}</div><div class="delete-btn">×</div>`;
                
                item.querySelector('.city-info').addEventListener('click', () => {
                    selectCity(city);
                    document.getElementById("searchHistory").style.display = 'none';
                    document.getElementById("citySearch").value = '';
                });
                
                item.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeFromHistory(index);
                });
                
                container.appendChild(item);
            });
        }
        
        async function searchCities(query) {
            if (!query || query.length < 2) return [];
            
            try {
                const url = `https://www.meteoblue.com/ru/server/search/query3?query=${encodeURIComponent(query)}&apikey=${API_KEY}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network error');
                const data = await response.json();
                return data.results || [];
            } catch (error) {
                return [];
            }
        }
        
        function encodeCity(name, country) {
            return encodeURIComponent(`${name}_${country}`).replace(/%/g, '%25');
        }
        
        function displayResults(results) {
            const container = document.getElementById("searchResults");
            container.innerHTML = !results || results.length === 0 ? 
                '<div class="search-result-item">Города не найдены</div>' : '';
            
            if (!results || results.length === 0) {
                container.style.display = 'block';
                return;
            }
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                const adminInfo = result.admin1 ? `, ${result.admin1}` : '';
                
                item.innerHTML = `
                    <span class="city-name">${result.name}</span>
                    <span class="country-name">${result.country}${adminInfo}</span>
                `;
                
                item.addEventListener('click', () => {
                    const city = {
                        id: result.id || result.geonameId || "",
                        name: result.name,
                        country: result.country,
                        lat: result.lat,
                        lon: result.lon,
                        encoded: encodeCity(result.name, result.country),
                        url: result.url || ''
                    };
                    
                    selectCity(city);
                    document.getElementById("searchResults").style.display = 'none';
                    document.getElementById("citySearch").value = '';
                    addToHistory(city);
                });
                
                container.appendChild(item);
            });
            
            container.style.display = 'block';
        }
        
        function selectCity(city) {
            selectedCity = city;
            
            // Сохраняем выбранный город в localStorage
            localStorage.setItem(LAST_CITY_KEY, JSON.stringify(city));
            
            if (city.id) {
                updateWeatherWidget(city);
                updateSatelliteWidget(city);
                updatePrecipitationWidget(city);
                updateWindWidget(city);
            } else if (city.lat && city.lon) {
                updateWidgetByCoords(city.lat, city.lon);
                updateSatelliteWidgetByCoords(city.lat, city.lon);
                updatePrecipitationWidgetByCoords(city.lat, city.lon);
                updateWindWidgetByCoords(city.lat, city.lon);
            }
        }
        
        function updateWeatherWidget(city) {
            const useUrl = city.url ? city.url : city.encoded;
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/widget/three/${useUrl}_${city.id}?geoloc=fixed&nocurrent=0&noforecast=0&days=7&tempunit=CELSIUS&windunit=METER_PER_SECOND&layout=image`;
            document.getElementById("weatherWidget").src = widgetSrc;
            console.log("Виджет прогноза обновлен:", widgetSrc);
        }
        
        function updateSatelliteWidget(city) {
            const useUrl = city.url ? city.url : city.encoded;
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/%D0%BA%D0%B0%D1%80%D1%82%D1%8B/widget/${useUrl}_${city.id}?windAnimation=0&gust=0&satellite=1&cloudsAndPrecipitation=0&temperature=0&sunshine=0&extremeForecastIndex=0&geoloc=fixed&tempunit=C&windunit=m%252Fs&lengthunit=metric&zoom=5&autowidth=manu`;
            document.getElementById("satelliteWidget").src = widgetSrc;
            console.log("Спутниковый виджет обновлен:", widgetSrc);
        }
        
        function updatePrecipitationWidget(city) {
            const useUrl = city.url ? city.url : city.encoded;
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/%D0%BA%D0%B0%D1%80%D1%82%D1%8B/widget/${useUrl}_${city.id}?windAnimation=0&gust=0&satellite=0&cloudsAndPrecipitation=1&temperature=0&sunshine=0&extremeForecastIndex=0&geoloc=fixed&tempunit=C&windunit=m%252Fs&lengthunit=metric&zoom=5&autowidth=manu`;
            document.getElementById("precipitationWidget").src = widgetSrc;
            console.log("Виджет осадков обновлен:", widgetSrc);
        }
        
        function updateWindWidget(city) {
            const useUrl = city.url ? city.url : city.encoded;
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/%D0%BA%D0%B0%D1%80%D1%82%D1%8B/widget/${useUrl}_${city.id}?windAnimation=1&gust=0&satellite=0&cloudsAndPrecipitation=0&temperature=0&sunshine=0&extremeForecastIndex=0&geoloc=fixed&tempunit=C&windunit=m%252Fs&lengthunit=metric&zoom=8&autowidth=manu`;
            document.getElementById("windWidget").src = widgetSrc;
            console.log("Виджет ветра обновлен:", widgetSrc);
        }
        
        function updateWidgetByCoords(lat, lon) {
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/widget/three/latlon?lat=${lat}&lon=${lon}&geoloc=fixed&nocurrent=0&noforecast=0&days=4&tempunit=CELSIUS&windunit=METER_PER_SECOND&layout=image&nolocation=1`;
            document.getElementById("weatherWidget").src = widgetSrc;
            console.log("Виджет прогноза по координатам обновлен:", widgetSrc);
        }
        
        function updateSatelliteWidgetByCoords(lat, lon) {
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/%D0%BA%D0%B0%D1%80%D1%82%D1%8B/widget/latlon?lat=${lat}&lon=${lon}&windAnimation=0&gust=0&satellite=1&cloudsAndPrecipitation=0&temperature=0&sunshine=0&extremeForecastIndex=0&geoloc=fixed&tempunit=C&windunit=m%252Fs&lengthunit=metric&zoom=5&autowidth=manu`;
            document.getElementById("satelliteWidget").src = widgetSrc;
        }
        
        function updatePrecipitationWidgetByCoords(lat, lon) {
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/%D0%BA%D0%B0%D1%80%D1%82%D1%8B/widget/latlon?lat=${lat}&lon=${lon}&windAnimation=0&gust=0&satellite=0&cloudsAndPrecipitation=1&temperature=0&sunshine=0&extremeForecastIndex=0&geoloc=fixed&tempunit=C&windunit=m%252Fs&lengthunit=metric&zoom=5&autowidth=manu`;
            document.getElementById("precipitationWidget").src = widgetSrc;
        }
        
        function updateWindWidgetByCoords(lat, lon) {
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/%D0%BA%D0%B0%D1%80%D1%82%D1%8B/widget/latlon?lat=${lat}&lon=${lon}&windAnimation=1&gust=0&satellite=0&cloudsAndPrecipitation=0&temperature=0&sunshine=0&extremeForecastIndex=0&geoloc=fixed&tempunit=C&windunit=m%252Fs&lengthunit=metric&zoom=8&autowidth=manu`;
            document.getElementById("windWidget").src = widgetSrc;
        }
        
        function resizeIframes() {
            console.log("Вызвана функция resizeIframes");
            // Масштабирование виджетов
            const containers = [
                { iframe: document.getElementById("weatherWidget"), container: document.querySelector(".widget-container") },
                { iframe: document.getElementById("satelliteWidget"), container: document.querySelector(".satellite-widget-container") },
                { iframe: document.getElementById("precipitationWidget"), container: document.querySelector(".precipitation-widget-container") },
                { iframe: document.getElementById("windWidget"), container: document.querySelector(".wind-widget-container") }
            ];
            
            containers.forEach(item => {
                if (item.iframe && item.container) {
                    const width = item.container.offsetWidth;
                    const scaleFactor = width / 460;
                    item.iframe.style.transform = `scale(${scaleFactor})`;
                    item.iframe.style.width = `${100 / scaleFactor}%`;
                    item.container.style.height = `${600 * scaleFactor}px`;
                    
                    // Проверка, не пуст ли iframe
                    if (!item.iframe.src || item.iframe.src === "about:blank" || item.iframe.src === "") {
                        console.log("Обнаружен пустой iframe:", item.iframe.id);
                        // Если это основной виджет прогноза, обновляем его
                        if (item.iframe.id === "weatherWidget" && selectedCity) {
                            console.log("Обновляем пустой weatherWidget");
                            updateWeatherWidget(selectedCity);
                        }
                    }
                }
            });
        }
        
        // Обработчики вкладок
        function switchToForecastTab() {
            console.log("Переключение на вкладку Прогноз");
            document.getElementById('forecastTab').classList.add('active');
            document.getElementById('satelliteTab').classList.remove('active');
            document.getElementById('precipitationTab').classList.remove('active');
            document.getElementById('windTab').classList.remove('active');
            
            document.querySelector('.widget-container').style.display = 'flex';
            document.querySelector('.satellite-widget-container').style.display = 'none';
            document.querySelector('.precipitation-widget-container').style.display = 'none';
            document.querySelector('.wind-widget-container').style.display = 'none';
            
            // Проверим, загружен ли виджет прогноза погоды
            const weatherWidget = document.getElementById("weatherWidget");
            if (!weatherWidget.src || weatherWidget.src === "about:blank" || weatherWidget.src === "") {
                console.log("Виджет прогноза пуст, загружаем снова");
                updateWeatherWidget(selectedCity);
            }
            
            // Принудительно вызываем resizeIframes для корректного отображения
            resizeIframes();
        }
        
        function switchToSatelliteTab() {
            console.log("Переключение на вкладку Спутник");
            document.getElementById('forecastTab').classList.remove('active');
            document.getElementById('satelliteTab').classList.add('active');
            document.getElementById('precipitationTab').classList.remove('active');
            document.getElementById('windTab').classList.remove('active');
            
            document.querySelector('.widget-container').style.display = 'none';
            document.querySelector('.satellite-widget-container').style.display = 'flex';
            document.querySelector('.precipitation-widget-container').style.display = 'none';
            document.querySelector('.wind-widget-container').style.display = 'none';
            
            // Принудительно вызываем resizeIframes для корректного отображения
            resizeIframes();
        }
        
        function switchToPrecipitationTab() {
            console.log("Переключение на вкладку Осадки");
            document.getElementById('forecastTab').classList.remove('active');
            document.getElementById('satelliteTab').classList.remove('active');
            document.getElementById('precipitationTab').classList.add('active');
            document.getElementById('windTab').classList.remove('active');
            
            document.querySelector('.widget-container').style.display = 'none';
            document.querySelector('.satellite-widget-container').style.display = 'none';
            document.querySelector('.precipitation-widget-container').style.display = 'flex';
            document.querySelector('.wind-widget-container').style.display = 'none';
            
            // Принудительно вызываем resizeIframes для корректного отображения
            resizeIframes();
        }
        
        function switchToWindTab() {
            console.log("Переключение на вкладку Ветер");
            document.getElementById('forecastTab').classList.remove('active');
            document.getElementById('satelliteTab').classList.remove('active');
            document.getElementById('precipitationTab').classList.remove('active');
            document.getElementById('windTab').classList.add('active');
            
            document.querySelector('.widget-container').style.display = 'none';
            document.querySelector('.satellite-widget-container').style.display = 'none';
            document.querySelector('.precipitation-widget-container').style.display = 'none';
            document.querySelector('.wind-widget-container').style.display = 'flex';
            
            // Принудительно вызываем resizeIframes для корректного отображения
            resizeIframes();
        }
        
        // Дополнительно блокируем стандартные жесты прокрутки документа
        document.addEventListener('touchmove', function(e) {
            // Блокируем только свайп вниз от самого верха страницы
            if (window.scrollY <= 0 && e.touches[0].clientY > 10 && e.touches[0].clientY < 100) {
                e.preventDefault();
            }
        }, { passive: false });
        
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById("citySearch");
            const searchButton = document.getElementById("searchButton");
            const searchResults = document.getElementById("searchResults");
            const searchHistory = document.getElementById("searchHistory");
            
            // Инициализация вкладок
            document.getElementById('forecastTab').addEventListener('click', switchToForecastTab);
            document.getElementById('satelliteTab').addEventListener('click', switchToSatelliteTab);
            document.getElementById('precipitationTab').addEventListener('click', switchToPrecipitationTab);
            document.getElementById('windTab').addEventListener('click', switchToWindTab);
            
            // Получаем последний выбранный город или используем город по умолчанию (Москва)
            const savedCity = localStorage.getItem(LAST_CITY_KEY);
            selectedCity = savedCity ? JSON.parse(savedCity) : DEFAULT_CITY;
            
            let debounceTimer;
            displayHistory();
            
            searchInput.addEventListener('focus', function() {
                if (searchInput.value.trim() === '') {
                    searchResults.style.display = 'none';
                    if (loadHistory().length > 0) {
                        searchHistory.style.display = 'block';
                    }
                } else if (searchInput.value.trim().length >= 2) {
                    searchHistory.style.display = 'none';
                    searchResults.style.display = 'block';
                }
            });
            
            searchInput.addEventListener('input', function() {
                clearTimeout(debounceTimer);
                
                if (searchInput.value.trim() === '') {
                    searchResults.style.display = 'none';
                    if (loadHistory().length > 0) {
                        searchHistory.style.display = 'block';
                    }
                    return;
                }
                
                searchHistory.style.display = 'none';
                
                debounceTimer = setTimeout(async () => {
                    const query = searchInput.value.trim();
                    if (query.length >= 2) {
                        try {
                            const results = await searchCities(query);
                            displayResults(results);
                        } catch (error) {
                            searchResults.innerHTML = '<div class="search-result-item">Ошибка при поиске</div>';
                            searchResults.style.display = 'block';
                        }
                    } else {
                        searchResults.style.display = 'none';
                    }
                }, 300);
            });
            
            searchInput.addEventListener('blur', function(e) {
                setTimeout(() => {
                    if (!document.activeElement.closest('#searchResults') && 
                        !document.activeElement.closest('#searchHistory')) {
                        searchResults.style.display = 'none';
                        searchHistory.style.display = 'none';
                    }
                }, 150);
            });
            
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && 
                    !searchResults.contains(e.target) && 
                    !searchHistory.contains(e.target)) {
                    searchResults.style.display = 'none';
                    searchHistory.style.display = 'none';
                }
            });
            
            if (searchButton) {
                searchButton.addEventListener('click', async function() {
                    const query = searchInput.value.trim();
                    if (query.length >= 2) {
                        searchResults.innerHTML = '<div class="loading">Загрузка...</div>';
                        searchResults.style.display = 'block';
                        searchHistory.classList.remove('active');
                        
                        try {
                            const results = await searchCities(query);
                            displayResults(results);
                        } catch (error) {
                            searchResults.innerHTML = '<div class="search-result-item">Ошибка при поиске</div>';
                            searchResults.style.display = 'block';
                        }
                    }
                });
            }
            
            // Устанавливаем выбранный город при загрузке для обоих виджетов
            updateWeatherWidget(selectedCity);
            updateMapWidget(selectedCity);
            
            // Инициализация вкладок
            document.getElementById('forecastTab').addEventListener('click', switchToForecastTab);
            document.getElementById('mapTab').addEventListener('click', switchToMapTab);
            
            // Всегда открываем приложение на вкладке "Прогноз погоды"
            switchToForecastTab();
            
            // Добавляем в историю только если это новый город
            const history = loadHistory();
            if (!history.some(item => item.id === selectedCity.id)) {
                addToHistory(selectedCity);
            }
        });
        
        window.addEventListener('load', function() {
            console.log("Страница полностью загружена");
            // Повторно назначаем обработчики событий для вкладок после полной загрузки
            document.getElementById('forecastTab').addEventListener('click', switchToForecastTab);
            document.getElementById('satelliteTab').addEventListener('click', switchToSatelliteTab);
            document.getElementById('precipitationTab').addEventListener('click', switchToPrecipitationTab);
            document.getElementById('windTab').addEventListener('click', switchToWindTab);
            
            // Повторно инициализируем виджеты
            if (selectedCity) {
                console.log("Обновляем виджеты для города:", selectedCity.name);
                updateWeatherWidget(selectedCity);
                updateSatelliteWidget(selectedCity);
                updatePrecipitationWidget(selectedCity);
                updateWindWidget(selectedCity);
            }
            
            resizeIframes();
            
            // Проверим, что все iframe элементы существуют
            console.log("Проверка iframe элементов:");
            console.log("weatherWidget:", document.getElementById("weatherWidget"));
            console.log("satelliteWidget:", document.getElementById("satelliteWidget"));
            console.log("precipitationWidget:", document.getElementById("precipitationWidget"));
            console.log("windWidget:", document.getElementById("windWidget"));
        });
        window.addEventListener('resize', resizeIframes);
    </script>
</body>
</html>
