import React, { useState, useEffect } from 'react';
import { Card } from '@/components/ui/card';

const NonogramGame = () => {
  const SIZE = 15;
  const [grid, setGrid] = useState(Array(SIZE).fill().map(() => Array(SIZE).fill(0)));
  const [solution] = useState(generatePuzzle());
  const [rowHints, setRowHints] = useState([]);
  const [colHints, setColHints] = useState([]);
  const [gameWon, setGameWon] = useState(false);

  useEffect(() => {
    const hints = calculateHints(solution);
    setRowHints(hints.rowHints);
    setColHints(hints.colHints);
  }, [solution]);

  function generatePuzzle() {
    const puzzle = Array(SIZE).fill().map(() => Array(SIZE).fill(0));
    for (let i = 0; i < SIZE; i++) {
      for (let j = 0; j < SIZE; j++) {
        puzzle[i][j] = Math.random() > 0.7 ? 1 : 0;
      }
    }
    return puzzle;
  }

  function calculateHints(puzzle) {
    const rowHints = [];
    const colHints = [];

    for (let i = 0; i < SIZE; i++) {
      const hints = [];
      let count = 0;
      for (let j = 0; j < SIZE; j++) {
        if (puzzle[i][j] === 1) {
          count++;
        } else if (count > 0) {
          hints.push(count);
          count = 0;
        }
      }
      if (count > 0) hints.push(count);
      rowHints.push(hints.length ? hints : [0]);
    }

    for (let j = 0; j < SIZE; j++) {
      const hints = [];
      let count = 0;
      for (let i = 0; i < SIZE; i++) {
        if (puzzle[i][j] === 1) {
          count++;
        } else if (count > 0) {
          hints.push(count);
          count = 0;
        }
      }
      if (count > 0) hints.push(count);
      colHints.push(hints.length ? hints : [0]);
    }

    return { rowHints, colHints };
  }

  function handleCellClick(row, col, rightClick = false) {
    if (gameWon) return;
    
    const newGrid = [...grid];
    if (rightClick) {
      newGrid[row][col] = newGrid[row][col] === 2 ? 0 : 2;
    } else {
      newGrid[row][col] = newGrid[row][col] === 1 ? 0 : 1;
    }
    setGrid(newGrid);
    checkWinCondition(newGrid);
  }

  function checkWinCondition(currentGrid) {
    for (let i = 0; i < SIZE; i++) {
      for (let j = 0; j < SIZE; j++) {
        if ((solution[i][j] === 1 && currentGrid[i][j] !== 1) ||
            (solution[i][j] === 0 && currentGrid[i][j] === 1)) {
          return;
        }
      }
    }
    setGameWon(true);
  }

  return (
    <Card className="p-6 bg-gray-900">
      <div className="flex flex-col items-center">
        <div className="mb-4 text-xl font-bold text-white">
          {gameWon ? "–ì–æ–ª–æ–≤–æ–ª–æ–º–∫–∞ —Ä–µ—à–µ–Ω–∞! üéâ" : "–Ø–ø–æ–Ω—Å–∫–∏–π –∫—Ä–æ—Å—Å–≤–æ—Ä–¥"}
        </div>
        
        <div className="flex">
          <div className="mt-16">
            {rowHints.map((hints, i) => (
              <div key={i} className="h-8 flex items-center justify-end pr-2 text-white">
                {hints.map((hint, j) => (
                  <span key={j} className="mx-1 text-sm font-mono">{hint}</span>
                ))}
              </div>
            ))}
          </div>
          
          <div>
            <div className="ml-2 mb-2">
              <div className="flex">
                {colHints.map((hints, i) => (
                  <div key={i} className="w-8 flex flex-col items-center justify-end text-white">
                    {hints.map((hint, j) => (
                      <span key={j} className="text-sm font-mono">{hint}</span>
                    ))}
                  </div>
                ))}
              </div>
            </div>
            
            <div className="grid gap-px bg-gray-600">
              {grid.map((row, i) => (
                <div key={i} className="flex gap-px">
                  {row.map((cell, j) => (
                    <div
                      key={j}
                      className={`w-8 h-8 flex items-center justify-center cursor-pointer
                        ${cell === 1 ? 'bg-blue-500' : cell === 2 ? 'bg-gray-800' : 'bg-gray-700'}
                        hover:opacity-90`}
                      onClick={() => handleCellClick(i, j)}
                      onContextMenu={(e) => {
                        e.preventDefault();
                        handleCellClick(i, j, true);
                      }}
                    >
                      {cell === 2 && <span className="text-gray-300">√ó</span>}
                    </div>
                  ))}
                </div>
              ))}
            </div>
          </div>
        </div>
        
        <div className="mt-4 text-sm text-white">
          –õ–µ–≤—ã–π –∫–ª–∏–∫ - –∑–∞–∫—Ä–∞—Å–∏—Ç—å ‚Ä¢ –ü—Ä–∞–≤—ã–π –∫–ª–∏–∫ - –æ—Ç–º–µ—Ç–∏—Ç—å
        </div>
      </div>
    </Card>
  );
};

export default NonogramGame;
