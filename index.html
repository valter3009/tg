<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—Ä–∏–ø—Ç–æ –ú–æ–Ω–∏—Ç–æ—Ä</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/telegram-web-app/6.7.0/telegram-web-app.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/reconnecting-websocket/1.0.0/reconnecting-websocket.min.js"></script>
    
    <style>
        :root {
            --tg-theme-bg-color: #fff;
            --tg-theme-text-color: #000;
            --tg-theme-hint-color: #999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #fff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            padding-bottom: 60px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 16px;
        }

        .navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--tg-theme-bg-color);
            border-top: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            padding: 8px;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--tg-theme-hint-color);
            text-decoration: none;
            font-size: 12px;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .nav-item.active {
            color: var(--tg-theme-button-color);
            background: rgba(36, 129, 204, 0.1);
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .input {
            flex: 1;
            padding: 12px;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            font-size: 14px;
            min-width: 120px;
        }

        .select {
            padding: 12px;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            font-size: 14px;
            background: var(--tg-theme-bg-color);
        }

        .button {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .button:disabled {
            opacity: 0.5;
        }

        .button.secondary {
            background: rgba(36, 129, 204, 0.1);
            color: var(--tg-theme-button-color);
        }

        .button.icon-button {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .pair-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .section-header {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--tg-theme-text-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .pair-item {
            background: rgba(0,0,0,0.03);
            border-radius: 12px;
            padding: 16px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-10px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .pair-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .pair-symbol {
            font-weight: 600;
            font-size: 16px;
        }

        .exchange-badge {
            font-size: 12px;
            padding: 4px 8px;
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
            color: var(--tg-theme-hint-color);
        }

        .price-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .price-card {
            padding: 12px;
            background: var(--tg-theme-bg-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .price-card:active {
            transform: scale(0.98);
        }

        .price-label {
            font-size: 12px;
            color: var(--tg-theme-hint-color);
            margin-bottom: 4px;
        }

        .price-value {
            font-size: 16px;
            font-weight: 500;
        }

        .price-value.bid {
            color: #4caf50;
        }

        .price-value.ask {
            color: #f44336;
        }

        .equation-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .equation-item {
            background: rgba(0,0,0,0.03);
            border-radius: 12px;
            padding: 16px;
        }

        .equation-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .equation-name {
            font-weight: 600;
            flex: 1;
        }

        .equation-result {
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
            background: var(--tg-theme-bg-color);
        }

        .equation-result.error {
            color: #f44336;
        }

        .equation-expression {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            white-space: nowrap;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px;
        }

        .equation-expression::-webkit-scrollbar {
            height: 4px;
        }

        .equation-expression::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.1);
            border-radius: 2px;
        }

        .fee-badge {
            background: rgba(36, 129, 204, 0.1);
            color: var(--tg-theme-button-color);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }

        .loading {
            color: var(--tg-theme-hint-color);
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="main" class="page active">
            <div class="input-group">
                <input type="text" id="equationInput" class="input" placeholder="–í–≤–µ–¥–∏—Ç–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ">
                <button id="addEquationBtn" class="button">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>

            <div class="input-group">
                <input type="text" id="feeInput" class="input" placeholder="–ö–æ–º–∏—Å—Å–∏—è %" value="0.02">
                <button id="applyFeeBtn" class="button secondary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–º–∏—Å—Å–∏—é</button>
            </div>

            <div class="section-header">
                –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—É
                <div class="fee-badge" id="feeIndicator">–ö–æ–º–∏—Å—Å–∏—è: 0.02%</div>
            </div>

            <div class="input-group">
                <input type="text" id="pairInput" class="input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: BTCUSDT">
                <select id="exchangeSelect" class="select">
                    <option value="Mexc">Mexc</option>
                    <option value="Bybit">Bybit</option>
                    <option value="OKX">OKX</option>
                </select>
                <button id="addPairBtn" class="button">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>

            <div id="pairList" class="pair-list"></div>
        </div>

        <div id="equations" class="page">
            <div class="section-header">
                –ê–∫—Ç–∏–≤–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
                <button class="button secondary" onclick="switchPage('main')">–í–µ—Ä–Ω—É—Ç—å—Å—è</button>
            </div>
            <div id="equationList" class="equation-list"></div>
        </div>
    </div>

    <nav class="navbar">
        <a href="#main" class="nav-item active" onclick="switchPage('main')">
            <div class="nav-icon">üìä</div>
            <span>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</span>
        </a>
        <a href="#equations" class="nav-item" onclick="switchPage('equations')">
            <div class="nav-icon">üìê</div>
            <span>–£—Ä–∞–≤–Ω–µ–Ω–∏—è</span>
        </a>
    </nav>

    <script>
        // Initialize Telegram WebApp
        const webapp = window.Telegram.WebApp;
        webapp.ready();
        webapp.expand();

        // Set theme colors
        document.documentElement.style.setProperty('--tg-theme-bg-color', webapp.themeParams.bg_color);
        document.documentElement.style.setProperty('--tg-theme-text-color', webapp.themeParams.text_color);
        document.documentElement.style.setProperty('--tg-theme-hint-color', webapp.themeParams.hint_color);
        document.documentElement.style.setProperty('--tg-theme-link-color', webapp.themeParams.link_color);
        document.documentElement.style.setProperty('--tg-theme-button-color', webapp.themeParams.button_color);
        document.documentElement.style.setProperty('--tg-theme-button-text-color', webapp.themeParams.button_text_color);

        // State management
        const state = {
            pairs: new Map(),
            equations: new Map(),
            websockets: new Map(),
            exchanges: {
                'Mexc': {
                    ws_url: 'wss://wbs.mexc.com/ws',
                    subscribe_format: (symbol) => ({
                        method: 'SUBSCRIPTION',
                        params: [`spot@public.bookTicker.v3.api@${symbol}`]
                    }),
                    parse_message: (data) => {
                        if (!data.s || !data.d) return null;
                        return {
                            symbol: data.s,
                            bid: data.d.b,
                            ask: data.d.a
                        };
                    },
                    ping_interval: 30000,
                    ping_message: { method: 'PING' }
                },
                'Bybit': {
                    ws_url: 'wss://stream.bybit.com/v5/public/spot',
                    subscribe_format: (symbol) => ({
                        op: 'subscribe',
                        args: [`orderbook.1.${symbol}`]
                    }),
                    parse_message: (data) => {
                        if (!data.data || !data.data.s) return null;
                        return {
                            symbol: data.data.s,
                            bid: data.data.b?.[0]?.[0],
                            ask: data.data.a?.[0]?.[0]
                        };
                    },
                    ping_interval: 20000,
                    ping_message: { op: 'ping' }
                },
                'OKX': {
                    ws_url: 'wss://ws.okx.com:8443/ws/v5/public',
                    subscribe_format: (symbol) => ({
                        op: 'subscribe',
                        args: [{
                            channel: 'tickers',
                            instId: symbol.includes('-') ? symbol : 
                                   symbol.endsWith('USDT') ? symbol.replace('USDT', '-USDT') :
                                   symbol.endsWith('BTC') ? symbol.replace('BTC', '-BTC') :
                                   `${symbol}-USDT`
                        }]
                    }),
                    parse_message: (data) => {
                        if (!data.data?.[0]) return null;
                        return {
                            symbol: data.data[0].instId.replace('-', ''),
                            bid: data.data[0].bidPx,
                            ask: data.data[0].askPx
                        };
                    },
                    ping_interval: 25000,
                    ping_message: { op: 'ping' }
                }
            }
        };

        // WebSocket Connection Management
        function connectWebSocket(exchange) {
            if (state.websockets.has(exchange)) {
                const ws = state.websockets.get(exchange);
                if (ws.readyState === WebSocket.OPEN) {
                    return Promise.resolve();
                }
            }

            return new Promise((resolve, reject) => {
                const config = state.exchanges[exchange];
                const ws = new ReconnectingWebSocket(config.ws_url);

                ws.onopen = () => {
                    console.log(`Connected to ${exchange}`);
                    // Resubscribe to all pairs for this exchange
                    for (const [key, pair] of state.pairs) {
                        if (pair.exchange === exchange) {
                            ws.send(JSON.stringify(config.subscribe_format(pair.symbol)));
                        }
                    }
                    resolve();
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        const parsed = config.parse_message(data);
                        if (parsed) {
                            updatePairPrices(parsed.symbol, exchange, parsed.bid, parsed.ask);
                        }
                    } catch (e) {
                        console.error('Error parsing message:', e);
                    }
                };

                ws.onerror = (error) => {
                    console.error(`WebSocket error for ${exchange}:`, error);
                    reject(error);
                };

                // Setup ping interval
                const pingInterval = setInterval(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify(config.ping_message));
                    }
                }, config.ping_interval);

                ws.onclose = () => {
                    clearInterval(pingInterval);
                    state.websockets.delete(exchange);
                };

                state.websockets.set(exchange, ws);
            });
        }

        // UI Updates
        function updatePairPrices(symbol, exchange, bid, ask) {
            const key = `${exchange}-${symbol}`;
            const pair = state.pairs.get(key);
            if (!pair) return;

            const element = document.getElementById(`pair-${key}`);
            if (element) {
                const bidElement = element.querySelector('.bid-value');
                const askElement = element.querySelector('.ask-value');
                
                if (bidElement && askElement) {
                    bidElement.textContent = parseFloat(bid).toFixed(8);
                    askElement.textContent = parseFloat(ask).toFixed(8);
                    
                    // Remove loading state if present
                    bidElement.classList.remove('loading');
                    askElement.classList.remove('loading');
                }
            }

            // Update equations that use this pair
            updateEquations();
        }

        async function addPair() {
            const symbol = document.getElementById('pairInput').value.trim().toUpperCase();
            const exchange = document.getElementById('exchangeSelect').value;
            const key = `${exchange}-${symbol}`;

            if (!symbol) {
                webapp.showPopup({
                    title: '–û—à–∏–±–∫–∞',
                    message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–æ—Ä–≥–æ–≤—É—é –ø–∞—Ä—É'
                });
                return;
            }

            if (state.pairs.has(key)) {
                webapp.showPopup({
                    title: '–û—à–∏–±–∫–∞',
                    message: '–≠—Ç–∞ –ø–∞—Ä–∞ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞'
                });
                return;
            }

            try {
                await connectWebSocket(exchange);
                
                state.pairs.set(key, { symbol, exchange });
                
                const ws = state.websockets.get(exchange);
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(state.exchanges[exchange].subscribe_format(symbol)));
                }

                const pairList = document.getElementById('pairList');
                const pairElement = document.createElement('div');
                pairElement.id = `pair-${key}`;
                pairElement.className = 'pair-item';
                pairElement.innerHTML = `
                    <div class="pair-header">
                        <div class="pair-symbol">${symbol}</div>
                        <div class="exchange-badge">${exchange}</div>
                    </div>
                    <div class="price-grid">
                        <div class="price-card" onclick="addToEquation('${symbol}_${exchange}_bid')">
                            <div class="price-label">–ü–æ–∫—É–ø–∫–∞</div>
                            <div class="price-value bid bid-value loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        </div>
                        <div class="price-card" onclick="addToEquation('${symbol}_${exchange}_ask')">
                            <div class="price-label">–ü—Ä–æ–¥–∞–∂–∞</div>
                            <div class="price-value ask ask-value loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        </div>
                    </div>
                    <button class="button icon-button" style="margin-top: 8px;" onclick="removePair('${key}')">√ó</button>
                `;
                
                // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –ø–∞—Ä—É –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
                if (pairList.firstChild) {
                    pairList.insertBefore(pairElement, pairList.firstChild);
                } else {
                    pairList.appendChild(pairElement);
                }
                
                document.getElementById('pairInput').value = '';

            } catch (error) {
                console.error('Error adding pair:', error);
                webapp.showPopup({
                    title: '–û—à–∏–±–∫–∞',
                    message: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∏—Ä–∂–µ'
                });
            }
        }

        function removePair(key) {
            const pair = state.pairs.get(key);
            if (!pair) return;

            // Remove from DOM
            const element = document.getElementById(`pair-${key}`);
            if (element) {
                element.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => element.remove(), 300);
            }

            // Remove from state
            state.pairs.delete(key);

            // Check if we need to disconnect websocket
            const hasOtherPairsForExchange = Array.from(state.pairs.values())
                .some(p => p.exchange === pair.exchange);
            
            if (!hasOtherPairsForExchange) {
                const ws = state.websockets.get(pair.exchange);
                if (ws) {
                    ws.close();
                    state.websockets.delete(pair.exchange);
                }
            }

            updateEquations();
        }

        function addEquation() {
            const expression = document.getElementById('equationInput').value.trim();
            if (!expression) {
                webapp.showPopup({
                    title: '–û—à–∏–±–∫–∞',
                    message: '–í–≤–µ–¥–∏—Ç–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ'
                });
                return;
            }

            const id = Date.now().toString();
            const name = `–£—Ä–∞–≤–Ω–µ–Ω–∏–µ_${state.equations.size + 1}`;
            
            state.equations.set(id, {
                name,
                expression
            });

            const equationList = document.getElementById('equationList');
            const equationElement = document.createElement('div');
            equationElement.id = `equation-${id}`;
            equationElement.className = 'equation-item';
            equationElement.innerHTML = `
                <div class="equation-header">
                    <input type="text" class="input equation-name" value="${name}" 
                           onchange="updateEquationName('${id}', this.value)">
                    <span class="equation-result loading" onclick="addToEquation('${name}_result')">–í—ã—á–∏—Å–ª–µ–Ω–∏–µ...</span>
                    <button class="button icon-button" onclick="removeEquation('${id}')">√ó</button>
                </div>
                <div class="equation-expression">${expression}</div>
            `;

            // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
            if (equationList.firstChild) {
                equationList.insertBefore(equationElement, equationList.firstChild);
            } else {
                equationList.appendChild(equationElement);
            }

            document.getElementById('equationInput').value = '';
            updateEquations();

            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Å —É—Ä–∞–≤–Ω–µ–Ω–∏—è–º–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏
            switchPage('equations');
        }

        function updateEquationName(id, newName) {
            const equation = state.equations.get(id);
            if (!equation) return;

            const oldName = equation.name;
            equation.name = newName;

            // Update other equations that might reference this one
            for (const [eqId, eq] of state.equations) {
                if (eq.expression.includes(`${oldName}_result`)) {
                    eq.expression = eq.expression.replace(`${oldName}_result`, `${newName}_result`);
                    const element = document.getElementById(`equation-${eqId}`);
                    if (element) {
                        element.querySelector('.equation-expression').textContent = eq.expression;
                    }
                }
            }

            updateEquations();
        }

        function removeEquation(id) {
            const equation = state.equations.get(id);
            if (!equation) return;

            // Remove from DOM with animation
            const element = document.getElementById(`equation-${id}`);
            if (element) {
                element.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => element.remove(), 300);
            }

            // Remove from state
            state.equations.delete(id);

            updateEquations();
        }

        function addToEquation(value) {
            const input = document.getElementById('equationInput');
            const cursorPos = input.selectionStart;
            const currentValue = input.value;
            input.value = currentValue.slice(0, cursorPos) + value + currentValue.slice(cursorPos);
            input.focus();
            input.setSelectionRange(cursorPos + value.length, cursorPos + value.length);
        }

        function applyFee() {
            const feeInput = document.getElementById('feeInput');
            const fee = parseFloat(feeInput.value.replace(',', '.'));
            
            if (isNaN(fee)) {
                webapp.showPopup({
                    title: '–û—à–∏–±–∫–∞',
                    message: '–ù–µ–≤–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏'
                });
                return;
            }

            document.getElementById('feeIndicator').textContent = `–ö–æ–º–∏—Å—Å–∏—è: ${fee}%`;
            
            const feeMultiplier = 1 - fee/100;
            const input = document.getElementById('equationInput');
            const cursorPos = input.selectionStart;
            const currentText = input.value;

            // Find nearest price reference to cursor
            const bidMatch = /[A-Z]+_[A-Za-z]+_bid/.exec(currentText);
            const askMatch = /[A-Z]+_[A-Za-z]+_ask/.exec(currentText);

            let match;
            if (bidMatch && askMatch) {
                // Use the closest match to cursor
                const bidDist = Math.abs(bidMatch.index - cursorPos);
                const askDist = Math.abs(askMatch.index - cursorPos);
                match = bidDist < askDist ? bidMatch : askMatch;
            } else {
                match = bidMatch || askMatch;
            }

            if (match) {
                const isBid = match[0].endsWith('bid');
                const replacement = isBid ? 
                    `(${match[0]}*${feeMultiplier})` : 
                    `(${match[0]}/${feeMultiplier})`;
                
                input.value = currentText.slice(0, match.index) + 
                             replacement + 
                             currentText.slice(match.index + match[0].length);
            }
        }

        function updateEquations() {
            for (const [id, equation] of state.equations) {
                const result = evaluateEquation(equation.expression);
                const element = document.getElementById(`equation-${id}`);
                if (element) {
                    const resultElement = element.querySelector('.equation-result');
                    if (resultElement) {
                        resultElement.textContent = result;
                        resultElement.classList.remove('loading');
                        resultElement.classList.toggle('error', result === 'n/d' || result.startsWith('–û—à–∏–±–∫–∞'));
                    }
                }
            }
        }

        function evaluateEquation(expression) {
            try {
                let evalStr = expression;

                // Replace equation references
                for (const [id, eq] of state.equations) {
                    const resultElement = document.getElementById(`equation-${id}`)?.querySelector('.equation-result');
                    if (resultElement) {
                        const result = resultElement.textContent;
                        if (result === 'n/d' || result === '–í—ã—á–∏—Å–ª–µ–Ω–∏–µ...') return 'n/d';
                        evalStr = evalStr.replace(`${eq.name}_result`, result);
                    }
                }

                // Replace pair values
                for (const [key, pair] of state.pairs) {
                    const element = document.getElementById(`pair-${key}`);
                    if (element) {
                        const bid = element.querySelector('.bid-value').textContent;
                        const ask = element.querySelector('.ask-value').textContent;
                        
                        if (bid === '–ó–∞–≥—Ä—É–∑–∫–∞...' || ask === '–ó–∞–≥—Ä—É–∑–∫–∞...') {
                            return '–ó–∞–≥—Ä—É–∑–∫–∞...';
                        }
                        
                        evalStr = evalStr.replace(`${pair.symbol}_${pair.exchange}_bid`, bid);
                        evalStr = evalStr.replace(`${pair.symbol}_${pair.exchange}_ask`, ask);
                    }
                }

                evalStr = evalStr.replace(/[^0-9+\-*/().]/g, '');
                const result = eval(evalStr);
                return isFinite(result) ? result.toFixed(8) : 'n/d';
            } catch (e) {
                return 'n/d';
            }
        }

        function switchPage(pageId) {
            // Update pages with animation
            document.querySelectorAll('.page').forEach(page => {
                if (page.id === pageId) {
                    page.style.display = 'block';
                    setTimeout(() => page.classList.add('active'), 50);
                } else {
                    page.classList.remove('active');
                    setTimeout(() => {
                        if (!page.classList.contains('active')) {
                            page.style.display = 'none';
                        }
                    }, 300);
                }
            });

            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.getAttribute('href') === `#${pageId}`);
            });

            // Update URL without page reload
            history.pushState(null, '', `#${pageId}`);
        }

        // Initialize default pairs
        const defaultPairs = [
            ['Mexc', 'BTCUSDT'], ['Bybit', 'BTCUSDT'], ['OKX', 'BTCUSDT'],
            ['Mexc', 'ETHUSDT'], ['Bybit', 'ETHUSDT'], ['OKX', 'ETHUSDT'],
            ['Mexc', 'ETHBTC'], ['Bybit', 'ETHBTC'], ['OKX', 'ETHBTC'],
            ['Mexc', 'XRPUSDT'], ['Bybit', 'XRPUSDT'], ['OKX', 'XRPUSDT'],
            ['Mexc', 'XUSDT'], ['Bybit', 'XUSDT'], ['OKX', 'XUSDT'],
            ['Mexc', 'SOLUSDT'], ['Bybit', 'SOLUSDT'], ['OKX', 'SOLUSDT']
        ];

        window.onload = async () => {
            // Initialize default pairs
            for (const [exchange, symbol] of defaultPairs) {
                document.getElementById('exchangeSelect').value = exchange;
                document.getElementById('pairInput').value = symbol;
                await addPair();
            }

            // Handle navigation based on URL hash
            const hash = window.location.hash.slice(1) || 'main';
            switchPage(hash);

            // Set up event listeners
            document.getElementById('addPairBtn').addEventListener('click', addPair);
            document.getElementById('addEquationBtn').addEventListener('click', addEquation);
            document.getElementById('applyFeeBtn').addEventListener('click', applyFee);

            // Add keyboard event listeners
            document.getElementById('pairInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addPair();
            });

            document.getElementById('equationInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addEquation();
            });

            document.getElementById('feeInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') applyFee();
            });

            // Listen for back button in Telegram WebApp
            webapp.onEvent('backButtonClicked', () => {
                if (document.getElementById('equations').classList.contains('active')) {
                    switchPage('main');
                    return true;
                }
                return false;
            });

            // Handle WebApp back button visibility
            window.addEventListener('hashchange', () => {
                const hash = window.location.hash.slice(1) || 'main';
                webapp.BackButton.isVisible = hash !== 'main';
            });

            // Handle MainButton visibility
            webapp.MainButton.setParams({
                text: '–î–û–ë–ê–í–ò–¢–¨ –ü–ê–†–£',
                color: webapp.themeParams.button_color,
            });

            webapp.MainButton.onClick(() => {
                addPair();
            });

            // Update MainButton visibility based on input
            document.getElementById('pairInput').addEventListener('input', (e) => {
                webapp.MainButton.isVisible = e.target.value.trim() !== '';
            });

            // Handle orientation changes and resize
            window.addEventListener('resize', () => {
                webapp.expand();
            });
        };

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            state.websockets.forEach(ws => ws.close());
        });

        // Add error handling for WebSocket connections
        window.addEventListener('offline', () => {
            webapp.showPopup({
                title: '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è',
                message: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É'
            });
        });

        // Add periodic price update check
        setInterval(() => {
            const now = Date.now();
            state.pairs.forEach((pair, key) => {
                const element = document.getElementById(`pair-${key}`);
                if (element) {
                    const bidElement = element.querySelector('.bid-value');
                    const askElement = element.querySelector('.ask-value');
                    
                    if (!bidElement || !askElement) return;
                    
                    const bid = bidElement.textContent;
                    const ask = askElement.textContent;
                    
                    if (bid === '–ó–∞–≥—Ä—É–∑–∫–∞...' || ask === '–ó–∞–≥—Ä—É–∑–∫–∞...') {
                        const ws = state.websockets.get(pair.exchange);
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify(state.exchanges[pair.exchange].subscribe_format(pair.symbol)));
                        }
                    }
                }
            });
        }, 5000);

        // Add storage support for equations
        try {
            const savedEquations = localStorage.getItem('equations');
            if (savedEquations) {
                const equations = JSON.parse(savedEquations);
                equations.forEach(eq => {
                    document.getElementById('equationInput').value = eq.expression;
                    addEquation();
                });
            }
        } catch (e) {
            console.error('Error loading saved equations:', e);
        }

        window.addEventListener('beforeunload', () => {
            try {
                const equations = Array.from(state.equations.values())
                    .map(eq => ({
                        name: eq.name,
                        expression: eq.expression
                    }));
                localStorage.setItem('equations', JSON.stringify(equations));
            } catch (e) {
                console.error('Error saving equations:', e);
            }
        });

        // Add haptic feedback for Telegram
        function vibrate(style = 'medium') {
            if (webapp.isVersionAtLeast('6.1')) {
                switch(style) {
                    case 'light':
                        webapp.HapticFeedback.impactOccurred('light');
                        break;
                    case 'medium':
                        webapp.HapticFeedback.impactOccurred('medium');
                        break;
                    case 'heavy':
                        webapp.HapticFeedback.impactOccurred('heavy');
                        break;
                    case 'rigid':
                        webapp.HapticFeedback.impactOccurred('rigid');
                        break;
                    case 'soft':
                        webapp.HapticFeedback.impactOccurred('soft');
                        break;
                }
            }
        }

        // Add haptic feedback to buttons
        document.querySelectorAll('.button').forEach(button => {
            button.addEventListener('click', () => vibrate('light'));
        });

        // Add haptic feedback to price cards
        document.addEventListener('click', (e) => {
            if (e.target.closest('.price-card')) {
                vibrate('soft');
            }
        });
    </script>
</body>
</html>
