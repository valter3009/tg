<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #fff;
            --tg-theme-text-color: #000;
            --tg-theme-hint-color: #999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #fff;
            --tg-theme-secondary-bg-color: #f4f4f5;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
        }

        .nav {
            display: flex;
            justify-content: space-around;
            background: var(--tg-theme-secondary-bg-color);
            padding: 0.5rem;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .nav-button {
            padding: 0.5rem 1rem;
            border: none;
            background: none;
            color: var(--tg-theme-text-color);
            font-size: 0.9rem;
        }

        .nav-button.active {
            color: var(--tg-theme-button-color);
        }

        .screen {
            display: none;
            padding-bottom: 4rem;
        }

        .screen.active {
            display: block;
        }

        .pair-input {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .pair-input input,
        .pair-input select {
            padding: 0.5rem;
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: 4px;
        }

        .pair-input button {
            padding: 0.5rem 1rem;
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 4px;
        }

        .pairs-list,
        .equations-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .pair-item,
        .equation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 4px;
        }

        .price {
            display: flex;
            gap: 1rem;
        }

        .bid { color: #22c55e; }
        .ask { color: #ef4444; }

        .equation-input {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .equation-input textarea {
            padding: 0.5rem;
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: 4px;
            min-height: 60px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--tg-theme-hint-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="pairs-screen" class="screen active">
            <div class="pair-input">
                <input type="text" id="pair-symbol" placeholder="Символ (например, BTCUSDT)">
                <select id="exchange-select">
                    <option value="Mexc">Mexc</option>
                    <option value="Bybit">Bybit</option>
                    <option value="OKX">OKX</option>
                </select>
                <button onclick="addPair()">Добавить</button>
            </div>
            <div id="pairs-list" class="pairs-list"></div>
        </div>

        <div id="equations-screen" class="screen">
            <div class="equation-input">
                <textarea id="equation-input" placeholder="Введите формулу"></textarea>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="number" id="fee-input" placeholder="Комиссия %" value="0.02" style="width: 100px;">
                    <button onclick="applyFee()">Применить комиссию</button>
                    <button onclick="addEquation()">Добавить формулу</button>
                </div>
            </div>
            <div id="equations-list" class="equations-list"></div>
        </div>

        <div id="settings-screen" class="screen">
            <div class="settings-item">
                <span>Уведомления о изменении цен</span>
                <input type="checkbox" id="price-notifications">
            </div>
            <div class="settings-item">
                <span>Интервал обновления (сек)</span>
                <input type="number" id="update-interval" value="1" min="1" max="60">
            </div>
        </div>
    </div>

    <div class="nav">
        <button class="nav-button active" onclick="showScreen('pairs')">Пары</button>
        <button class="nav-button" onclick="showScreen('equations')">Формулы</button>
        <button class="nav-button" onclick="showScreen('settings')">Настройки</button>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let pairs = {};
        let equations = {};
        let connections = {};
        
        // Инициализация Telegram WebApp
        tg.expand();
        tg.ready();

        // Применение темы Telegram
        function applyTgTheme() {
            document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color);
            document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color);
            document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color);
            document.documentElement.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color);
            document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color);
            document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color);
            document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color);
        }

        // Навигация между экранами
        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${screenName}-screen`).classList.add('active');
            document.querySelector(`.nav-button[onclick="showScreen('${screenName}')"]`).classList.add('active');
        }

        // WebSocket подключения
        const exchangeConfigs = {
            'Mexc': {
                wsUrl: 'wss://wbs.mexc.com/ws',
                subscribeFormat: (symbol) => ({
                    method: 'SUBSCRIPTION',
                    params: [`spot@public.bookTicker.v3.api@${symbol}`]
                }),
                parseMessage: (data) => {
                    if (data.s && data.d) {
                        return {
                            symbol: data.s,
                            bid: data.d.b,
                            ask: data.d.a
                        };
                    }
                    return null;
                }
            },
            'Bybit': {
                wsUrl: 'wss://stream.bybit.com/v5/public/spot',
                subscribeFormat: (symbol) => ({
                    op: 'subscribe',
                    args: [`orderbook.1.${symbol}`]
                }),
                parseMessage: (data) => {
                    if (data.data && data.data.s) {
                        return {
                            symbol: data.data.s,
                            bid: data.data.b[0][0],
                            ask: data.data.a[0][0]
                        };
                    }
                    return null;
                }
            },
            'OKX': {
                wsUrl: 'wss://ws.okx.com:8443/ws/v5/public',
                subscribeFormat: (symbol) => ({
                    op: 'subscribe',
                    args: [{
                        channel: 'tickers',
                        instId: symbol.replace('USDT', '-USDT').replace('BTC', '-BTC')
                    }]
                }),
                parseMessage: (data) => {
                    if (data.data && data.data[0]) {
                        return {
                            symbol: data.data[0].instId.replace('-', ''),
                            bid: data.data[0].bidPx,
                            ask: data.data[0].askPx
                        };
                    }
                    return null;
                }
            }
        };

        async function connectWebSocket(exchange, symbol) {
            const config = exchangeConfigs[exchange];
            const ws = new WebSocket(config.wsUrl);
            
            ws.onopen = () => {
                ws.send(JSON.stringify(config.subscribeFormat(symbol)));
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                const parsed = config.parseMessage(data);
                if (parsed) {
                    updatePairPrices(exchange, parsed.symbol, parsed.bid, parsed.ask);
                }
            };
            
            ws.onerror = (error) => {
                console.error(`WebSocket error for ${exchange}:`, error);
            };
            
            ws.onclose = () => {
                setTimeout(() => connectWebSocket(exchange, symbol), 5000);
            };
            
            return ws;
        }

        // Управление парами
        function addPair() {
            const symbol = document.getElementById('pair-symbol').value.toUpperCase();
            const exchange = document.getElementById('exchange-select').value;
            
            if (!symbol) {
                tg.showAlert('Введите символ пары');
                return;
            }
            
            const pairKey = `${exchange}_${symbol}`;
            if (pairs[pairKey]) {
                tg.showAlert('Эта пара уже добавлена');
                return;
            }

            const pairElement = document.createElement('div');
            pairElement.className = 'pair-item';
            pairElement.innerHTML = `
                <span>${symbol} ${exchange}</span>
                <div class="price">
                    <span class="bid">Загрузка...</span>
                    <span class="ask">Загрузка...</span>
                    <button onclick="removePair('${pairKey}')">×</button>
                </div>
            `;
            
            document.getElementById('pairs-list').appendChild(pairElement);
            pairs[pairKey] = pairElement;
            
            connectWebSocket(exchange, symbol).then(ws => {
                connections[pairKey] = ws;
            });
            
            document.getElementById('pair-symbol').value = '';
        }

        function removePair(pairKey) {
            if (pairs[pairKey]) {
                pairs[pairKey].remove();
                delete pairs[pairKey];
                
                if (connections[pairKey]) {
                    connections[pairKey].close();
                    delete connections[pairKey];
                }
                
                updateEquations();
            }
        }

        function updatePairPrices(exchange, symbol, bid, ask) {
            const pairKey = `${exchange}_${symbol}`;
            const pairElement = pairs[pairKey];
            
            if (pairElement) {
                const bidElement = pairElement.querySelector('.bid');
                const askElement = pairElement.querySelector('.ask');
                
                const oldBid = bidElement.textContent;
                const oldAsk = askElement.textContent;
                
                bidElement.textContent = bid;
                askElement.textContent = ask;
                
                if (document.getElementById('price-notifications').checked) {
                    if (oldBid !== 'Загрузка...' && oldAsk !== 'Загрузка...') {
                        if (bid !== oldBid || ask !== oldAsk) {
                            tg.showAlert(`${symbol} ${exchange}\nBid: ${bid}\nAsk: ${ask}`);
                        }
                    }
                }
                
                updateEquations();
            }
        }

        // Управление формулами
        function addEquation() {
            const equation = document.getElementById('equation-input').value.trim();
            if (!equation) return;
            
            const equationElement = document.createElement('div');
            equationElement.className = 'equation-item';
            equationElement.innerHTML = `
                <div>
                    <div>${equation}</div>
                    <div class="result">Вычисление...</div>
                </div>
                <button onclick="removeEquation('${equation}')">×</button>
            `;
            
            document.getElementById('equations-list').appendChild(equationElement);
            equations[equation] = equationElement;
            
            document.getElementById('equation-input').value = '';
            updateEquations();
        }

        function removeEquation(equation) {
            if (equations[equation]) {
                equations[equation].remove();
                delete equations[equation];
                updateEquations();
            }
        }

        function applyFee() {
            const fee = parseFloat(document.getElementById('fee-input').value);
            const equationInput = document.getElementById('equation-input');
            const equation = equationInput.value;
            
            if (isNaN(fee)) {
                tg.showAlert('Введите корректное значение комиссии');
                return;
            }
            
            const feeMultiplier = 1 - fee/100;
            const cursor = equationInput.selectionStart;
            
            const variables = equation.match(/[A-Z]+_(?:Mexc|Bybit|OKX)_(?:bid|ask)/g) || [];
            if (!variables.length) {
                tg.showAlert('Выберите пару для применения комиссии');
                return;
            }
            
            let nearestVar = variables.reduce((nearest, current) => {
                const currentPos = equation.indexOf(current);
                const nearestPos = equation.indexOf(nearest);
                return Math.abs(currentPos - cursor) < Math.abs(nearestPos - cursor) ? current : nearest;
            });
            
            const isBid = nearestVar.endsWith('_bid');
            const replacement = isBid ? 
                `(${nearestVar}*${feeMultiplier})` : 
                `(${nearestVar}/${feeMultiplier})`;
            
            const newEquation = equation.replace(nearestVar, replacement);
            equationInput.value = newEquation;
        }

        function evaluateEquation(equation) {
            try {
                let evalStr = equation;
                
                // Заменяем значения пар на их текущие цены
                const variables = equation.match(/[A-Z]+_(?:Mexc|Bybit|OKX)_(?:bid|ask)/g) || [];
                for (const variable of variables) {
                    const [symbol, exchange, priceType] = variable.split('_');
                    const pairKey = `${exchange}_${symbol}`;
                    
                    if (!pairs[pairKey]) {
                        return 'н/д';
                    }
                    
                    const priceElement = pairs[pairKey].querySelector(`.${priceType}`);
                    const price = priceElement.textContent;
                    
                    if (price === 'Загрузка...') {
                        return 'Загрузка...';
                    }
                    
                    evalStr = evalStr.replace(variable, price);
                }
                
                // Очищаем строку от пробелов
                evalStr = evalStr.replace(/\s+/g, '');
                
                // Проверяем на недопустимые символы
                if (!/^[0-9.+\-*/() ]+$/.test(evalStr)) {
                    return 'н/д';
                }
                
                // Вычисляем результат с помощью Decimal.js для точности
                const result = new Decimal(eval(evalStr));
                return result.toFixed(8);
                
            } catch (error) {
                console.error('Ошибка вычисления:', error);
                return 'Ошибка';
            }
        }

        function updateEquations() {
            for (const [equation, element] of Object.entries(equations)) {
                const result = evaluateEquation(equation);
                const resultElement = element.querySelector('.result');
                resultElement.textContent = result;
                
                if (result === 'н/д' || result === 'Ошибка') {
                    resultElement.style.color = '#ef4444';
                } else {
                    resultElement.style.color = 'inherit';
                }
            }
        }

        // Сохранение настроек
        function saveSettings() {
            const settings = {
                priceNotifications: document.getElementById('price-notifications').checked,
                updateInterval: document.getElementById('update-interval').value,
                pairs: Object.keys(pairs),
                equations: Object.keys(equations)
            };
            
            localStorage.setItem('cryptoMonitorSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('cryptoMonitorSettings'));
                if (settings) {
                    document.getElementById('price-notifications').checked = settings.priceNotifications;
                    document.getElementById('update-interval').value = settings.updateInterval;
                    
                    // Восстанавливаем пары
                    settings.pairs.forEach(pairKey => {
                        const [exchange, symbol] = pairKey.split('_');
                        document.getElementById('pair-symbol').value = symbol;
                        document.getElementById('exchange-select').value = exchange;
                        addPair();
                    });
                    
                    // Восстанавливаем формулы
                    settings.equations.forEach(equation => {
                        document.getElementById('equation-input').value = equation;
                        addEquation();
                    });
                }
            } catch (error) {
                console.error('Ошибка загрузки настроек:', error);
            }
        }

        // Обработчики событий
        document.getElementById('pair-symbol').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addPair();
            }
        });

        document.getElementById('equation-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                addEquation();
            }
        });

        // События для сохранения настроек
        ['price-notifications', 'update-interval'].forEach(id => {
            document.getElementById(id).addEventListener('change', saveSettings);
        });

        // Инициализация
        function initialize() {
            applyTgTheme();
            loadSettings();
            
            // Запускаем периодическое обновление
            setInterval(() => {
                const interval = parseInt(document.getElementById('update-interval').value);
                if (!isNaN(interval) && interval >= 1) {
                    updateEquations();
                }
            }, 1000);
            
            // Добавляем обработчик изменения темы Telegram
            tg.onEvent('themeChanged', applyTgTheme);
        }

        initialize();
    </script>
</body>
</html>
