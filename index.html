<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–æ–Ω–∏–º–Ω—ã–π –≤–∏–¥–µ–æ—á–∞—Ç</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: white;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(0, 0, 0, 0.8);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            z-index: 100;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4757;
            animation: pulse 2s infinite;
        }

        .status-dot.connecting { background: #ffa502; }
        .status-dot.connected { background: #2ed573; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .video-container {
            flex: 1;
            position: relative;
            background: #000;
        }

        .videos {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #localVideo {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 150px;
            height: 100px;
            border-radius: 10px;
            border: 2px solid #333;
            background: #2a2a2a;
            z-index: 10;
            object-fit: cover;
        }

        #remoteVideo {
            width: 100%;
            height: 100%;
            background: #000;
            object-fit: cover;
        }

        .controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 20;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .mic-btn {
            background: #2ed573;
        }

        .mic-btn.muted {
            background: #ff4757;
        }

        .camera-btn {
            background: #667eea;
        }

        .camera-btn.disabled {
            background: #ff4757;
        }

        .hangup-btn {
            background: #ff4757;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 30;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px 30px;
            border-radius: 10px;
            z-index: 25;
            max-width: 300px;
        }

        .error {
            background: rgba(255, 71, 87, 0.9);
        }

        .success {
            background: rgba(46, 213, 115, 0.9);
        }

        .connection-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 15;
        }

        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 768px) {
            #localVideo {
                width: 120px;
                height: 80px;
                top: 15px;
                right: 15px;
            }
            
            .controls {
                bottom: 20px;
                gap: 10px;
            }
            
            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .connection-info {
                top: 15px;
                left: 15px;
                padding: 8px 12px;
                font-size: 11px;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <div class="status-dot" id="statusDot"></div>
                –ê–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç
            </h1>
            <div id="connectionStatus">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
        </div>
        
        <div class="video-container">
            <div class="videos">
                <video id="remoteVideo" autoplay playsinline></video>
                <video id="localVideo" autoplay muted playsinline></video>
            </div>
            
            <div class="connection-info" id="connectionInfo">
                <div>–ö–æ–º–Ω–∞—Ç–∞: <span id="roomId">-</span></div>
                <div>–°—Ç–∞—Ç—É—Å: <span id="rtcStatus">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</span></div>
            </div>
            
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</p>
                <p style="font-size: 14px; margin-top: 10px; opacity: 0.7;">
                    –û–∂–∏–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                </p>
            </div>
            
            <div class="status-message hidden" id="statusMessage"></div>
            
            <div class="controls">
                <button class="control-btn mic-btn" id="micBtn" onclick="toggleMicrophone()">
                    üé§
                </button>
                <button class="control-btn camera-btn" id="cameraBtn" onclick="toggleCamera()">
                    üìπ
                </button>
                <button class="control-btn hangup-btn" onclick="endCall()">
                    üìû
                </button>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let roomId = null;
        let isInitiator = false;
        let isConnected = false;
        let pollingInterval = null;
        let connectionAttempts = 0;
        let maxConnectionAttempts = 10;

        // WebRTC –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const rtcConfiguration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        };

        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] [${type.toUpperCase()}] ${message}`);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(status, type = 'info') {
            const statusEl = document.getElementById('connectionStatus');
            const statusDot = document.getElementById('statusDot');
            const rtcStatusEl = document.getElementById('rtcStatus');
            
            statusEl.textContent = status;
            rtcStatusEl.textContent = status;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            statusDot.className = 'status-dot';
            if (type === 'connected') {
                statusDot.classList.add('connected');
            } else if (type === 'connecting') {
                statusDot.classList.add('connecting');
            }
            
            log(`–°—Ç–∞—Ç—É—Å: ${status}`);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(message, type = 'info', duration = 3000) {
            const messageEl = document.getElementById('statusMessage');
            messageEl.textContent = message;
            messageEl.className = `status-message ${type}`;
            
            setTimeout(() => {
                messageEl.classList.add('hidden');
            }, duration);
        }

        // –°–∫—Ä—ã—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–¥–∏–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        async function initializeMedia() {
            try {
                updateStatus('–ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'connecting');
                
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                log('–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
                
                updateStatus('–°–æ–∑–¥–∞–µ–º WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ', 'connecting');
                await initializePeerConnection();
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞: ${error.message}`, 'error');
                showMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
                updateStatus('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞', 'error');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        async function initializePeerConnection() {
            try {
                peerConnection = new RTCPeerConnection(rtcConfiguration);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
                peerConnection.ontrack = (event) => {
                    log('–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫');
                    remoteStream = event.streams[0];
                    document.getElementById('remoteVideo').srcObject = remoteStream;
                    hideLoading();
                    updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
                    isConnected = true;
                    showMessage('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
                };
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º ICE candidate');
                        sendSignal({
                            type: 'ice-candidate',
                            data: {
                                candidate: event.candidate.candidate,
                                sdpMLineIndex: event.candidate.sdpMLineIndex,
                                sdpMid: event.candidate.sdpMid
                            }
                        });
                    }
                };
                
                // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                peerConnection.onconnectionstatechange = () => {
                    const state = peerConnection.connectionState;
                    log(`–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${state}`);
                    
                    switch (state) {
                        case 'connected':
                            updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
                            isConnected = true;
                            hideLoading();
                            break;
                        case 'connecting':
                            updateStatus('–°–æ–µ–¥–∏–Ω—è–µ–º—Å—è...', 'connecting');
                            break;
                        case 'disconnected':
                            updateStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ', 'error');
                            showMessage('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ', 'error');
                            break;
                        case 'failed':
                            updateStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
                            showMessage('–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ', 'error');
                            break;
                    }
                };
                
                log('WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫—Ç–æ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –∑–≤–æ–Ω–æ–∫ (–ø–µ—Ä–≤—ã–π –ø–æ–¥–∫–ª—é—á–∏–≤—à–∏–π—Å—è)
                setTimeout(async () => {
                    if (!isConnected && connectionAttempts < maxConnectionAttempts) {
                        isInitiator = true;
                        log('–°—Ç–∞–Ω–æ–≤–∏–º—Å—è –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–æ–º');
                        await createOffer();
                    }
                }, 2000);
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ WebRTC: ${error.message}`, 'error');
                updateStatus('–û—à–∏–±–∫–∞ WebRTC', 'error');
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ offer
        async function createOffer() {
            try {
                updateStatus('–°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'connecting');
                
                const offer = await peerConnection.createOffer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: true
                });
                
                await peerConnection.setLocalDescription(offer);
                
                log('Offer —Å–æ–∑–¥–∞–Ω –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ');
                
                sendSignal({
                    type: 'offer',
                    data: {
                        sdp: offer.sdp,
                        type: offer.type
                    }
                });
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer: ${error.message}`, 'error');
                showMessage('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è', 'error');
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ answer
        async function createAnswer(offerData) {
            try {
                updateStatus('–û—Ç–≤–µ—á–∞–µ–º –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ', 'connecting');
                
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offerData));
                
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                log('Answer —Å–æ–∑–¥–∞–Ω –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ');
                
                sendSignal({
                    type: 'answer',
                    data: {
                        sdp: answer.sdp,
                        type: answer.type
                    }
                });
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è answer: ${error.message}`, 'error');
                showMessage('–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ', 'error');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ answer
        async function handleAnswer(answerData) {
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answerData));
                log('Answer –æ–±—Ä–∞–±–æ—Ç–∞–Ω');
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ answer: ${error.message}`, 'error');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE candidate
        async function handleIceCandidate(candidateData) {
            try {
                const candidate = new RTCIceCandidate({
                    candidate: candidateData.candidate,
                    sdpMLineIndex: candidateData.sdpMLineIndex,
                    sdpMid: candidateData.sdpMid
                });
                
                await peerConnection.addIceCandidate(candidate);
                log('ICE candidate –¥–æ–±–∞–≤–ª–µ–Ω');
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ICE candidate: ${error.message}`, 'error');
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–∞ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞
        function sendSignal(signal) {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Telegram WebApp API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É
                if (window.Telegram && window.Telegram.WebApp) {
                    const signalData = JSON.stringify(signal);
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ –Ω–µ–≤–∏–¥–∏–º—É—é —Ñ–æ—Ä–º—É –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥
                    fetch(`https://api.telegram.org/bot7807194370:AAH0bbTu_HwaOXUOoT2DU9oGS0xDIHSSjSs/sendMessage`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            chat_id: window.Telegram.WebApp.initDataUnsafe?.user?.id,
                            text: `/webrtc_signal ${signalData}`
                        })
                    });
                }
                
                log(`–°–∏–≥–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: ${signal.type}`);
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∏–≥–Ω–∞–ª–∞: ${error.message}`, 'error');
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤ –æ—Ç –±–æ—Ç–∞
        async function pollSignals() {
            try {
                if (window.Telegram && window.Telegram.WebApp) {
                    const response = await fetch(`https://api.telegram.org/bot7807194370:AAH0bbTu_HwaOXUOoT2DU9oGS0xDIHSSjSs/sendMessage`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            chat_id: window.Telegram.WebApp.initDataUnsafe?.user?.id,
                            text: '/get_signals'
                        })
                    });
                    
                    // –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
                    // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º polling —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
                }
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤: ${error.message}`, 'error');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
        function processSignals(signals) {
            signals.forEach(async (signal) => {
                log(`–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª: ${signal.type}`);
                
                switch (signal.type) {
                    case 'offer':
                        if (!isInitiator) {
                            await createAnswer(signal.data);
                        }
                        break;
                    case 'answer':
                        if (isInitiator) {
                            await handleAnswer(signal.data);
                        }
                        break;
                    case 'ice-candidate':
                        await handleIceCandidate(signal.data);
                        break;
                    case 'disconnect':
                        endCall();
                        break;
                }
            });
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º
        function toggleMicrophone() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    const micBtn = document.getElementById('micBtn');
                    
                    if (audioTrack.enabled) {
                        micBtn.classList.remove('muted');
                        micBtn.textContent = 'üé§';
                        showMessage('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω', 'success', 1000);
                    } else {
                        micBtn.classList.add('muted');
                        micBtn.textContent = 'üé§';
                        showMessage('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω', 'info', 1000);
                    }
                    
                    log(`–ú–∏–∫—Ä–æ—Ñ–æ–Ω ${audioTrack.enabled ? '–≤–∫–ª—é—á–µ–Ω' : '–≤—ã–∫–ª—é—á–µ–Ω'}`);
                }
            }
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π
        function toggleCamera() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    const cameraBtn = document.getElementById('cameraBtn');
                    
                    if (videoTrack.enabled) {
                        cameraBtn.classList.remove('disabled');
                        cameraBtn.textContent = 'üìπ';
                        showMessage('–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞', 'success', 1000);
                    } else {
                        cameraBtn.classList.add('disabled');
                        cameraBtn.textContent = 'üìπ';
                        showMessage('–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞', 'info', 1000);
                    }
                    
                    log(`–ö–∞–º–µ—Ä–∞ ${videoTrack.enabled ? '–≤–∫–ª—é—á–µ–Ω–∞' : '–≤—ã–∫–ª—é—á–µ–Ω–∞'}`);
                }
            }
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
        function endCall() {
            log('–ó–∞–≤–µ—Ä—à–∞–µ–º –∑–≤–æ–Ω–æ–∫');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
            sendSignal({
                type: 'disconnect',
                data: {}
            });
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            if (peerConnection) {
                peerConnection.close();
            }
            
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.close();
            } else {
                window.close();
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function initializeApp() {
            try {
                roomId = getUrlParameter('room');
                
                if (!roomId) {
                    showMessage('–ù–µ —É–∫–∞–∑–∞–Ω ID –∫–æ–º–Ω–∞—Ç—ã', 'error');
                    return;
                }
                
                document.getElementById('roomId').textContent = roomId;
                log(`–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã: ${roomId}`);
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.ready();
                    window.Telegram.WebApp.expand();
                    window.Telegram.WebApp.setHeaderColor('#1a1a1a');
                    window.Telegram.WebApp.setBackgroundColor('#1a1a1a');
                    
                    // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
                    window.Telegram.WebApp.BackButton.show();
                    window.Telegram.WebApp.BackButton.onClick(endCall);
                    
                    log('Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                } else {
                    log('Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º');
                }
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –º–µ–¥–∏–∞
                await initializeMedia();
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º polling —Å–∏–≥–Ω–∞–ª–æ–≤
                pollingInterval = setInterval(pollSignals, 1000);
                
                log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ${error.message}`, 'error');
                showMessage('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏', 'error');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞
        window.addEventListener('beforeunload', () => {
            endCall();
        });

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ');
            setTimeout(initializeApp, 500);
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        window.addEventListener('error', (event) => {
            log(`JavaScript –æ—à–∏–±–∫–∞: ${event.error?.message}`, 'error');
            showMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è', 'error');
        });
    </script>
</body>
</html>
