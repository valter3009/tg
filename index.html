<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Погодный виджет</title>
    <!-- Telegram WebApp Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
    
        ym(101522448, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true
        });
        
        function getParameterByName(name) {
            var url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
        
        window.onload = function() {
            var source = getParameterByName('source') || 'unknown';
            var userId = getParameterByName('user_id') || 'unknown';
            
            ym(101522448, 'reachGoal', 'webapp_open', {
                source: source,
                user_id: userId
            });
            
            // Инициализация Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                // Отключаем возможность закрытия приложения свайпом
                // Устанавливаем параметры viewport для запрета закрытия приложения свайпом
                window.Telegram.WebApp.setViewportSettings({
                    can_be_closed: true,                // Приложение может быть закрыто (кнопкой)
                    disable_swipe_to_close: true,       // Отключаем закрытие свайпом
                    disable_pulling_to_refresh: true    // Отключаем обновление страницы свайпом
                });
                
                // Адаптируем тему приложения
                const tgColorScheme = window.Telegram.WebApp.colorScheme;
                if (tgColorScheme === 'dark') {
                    document.body.classList.add('dark-theme');
                }
                
                // Включаем расширение на весь экран
                window.Telegram.WebApp.expand();
            }
        };
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/101522448" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
    <style>
        html, body {
            overscroll-behavior-y: none; /* Предотвращает свайп браузера для обновления страницы */
            touch-action: pan-x pan-y; /* Разрешаем стандартную прокрутку, но контролируем её в JS */
        }
        body {font-family:Arial,sans-serif; margin:0; padding:10px; background-color:#0F4778; overflow-x:hidden; color:#eee;}
        .container {width:100%; max-width:500px; margin:0 auto; display:flex; flex-direction:column; align-items:center;}
        .search-container {width:100%; margin-bottom:15px; position:relative;}
        .search-input {width:100%; padding:12px; border:1px solid #333; border-radius:8px; font-size:16px; background-color:#87CEEB; color:#333; box-sizing:border-box;}
        .search-input::placeholder {color:#444;}
        .search-results {position:absolute; width:100%; max-height:200px; overflow-y:auto; background-color:rgba(135, 206, 235, 0.6); -webkit-backdrop-filter:blur(2px); backdrop-filter:blur(2px); border:1px solid rgba(51, 51, 51, 0.5); border-radius:0 0 8px 8px; z-index:1000; display:none; box-shadow:0 4px 8px rgba(0,0,0,0.15);}
        .search-result-item {padding:10px; cursor:pointer; border-bottom:1px solid rgba(51, 51, 51, 0.3);}
        .search-result-item:hover {background-color:rgba(135, 206, 235, 0.8);}
        .city-name {font-weight:bold; color:#000; text-shadow: 0px 0px 3px rgba(255, 255, 255, 0.7);}
        .country-name {color:#222; font-size:14px; text-shadow: 0px 0px 3px rgba(255, 255, 255, 0.7);}
        .search-history {width:100%; display:none; background-color:rgba(135, 206, 235, 0.6); -webkit-backdrop-filter:blur(2px); backdrop-filter:blur(2px); border:1px solid rgba(51, 51, 51, 0.5); border-radius:0 0 8px 8px; position:absolute; top:100%; z-index:900; box-shadow:0 4px 8px rgba(0,0,0,0.15);}
        .history-item {padding:8px 10px; cursor:pointer; border-bottom:1px solid rgba(51, 51, 51, 0.3); display:flex; justify-content:space-between; align-items:center; font-size:14px; color:#000; text-shadow: 0px 0px 3px rgba(255, 255, 255, 0.7);}
        .history-item:hover {background-color:rgba(135, 206, 235, 0.95);}
        .city-info {flex-grow:1;}
        .delete-btn {color:#ff5252; cursor:pointer; padding:2px 6px; font-size:14px; border-radius:4px;}
        .delete-btn:hover {background-color:rgba(255,82,82,0.2);}
        .widget-container {width:100%; display:flex; justify-content:center; align-items:flex-start; background-color:#1e1e1e; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.3); overflow:hidden; position:relative; padding:0; margin-bottom:15px;}
        .iframe-wrapper {width:100%; position:relative; overflow:hidden;}
        iframe {border:none; width:100%; height:620px; transform-origin:0 0; margin:0;}
        .map-widget-container {width:100%; display:flex; justify-content:center; align-items:flex-start; background-color:#1e1e1e; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.3); overflow:hidden; position:relative; padding:0; margin-bottom:15px;}
        .map-iframe-wrapper {width:100%; position:relative; overflow:hidden;}
        .loading {text-align:center; padding:20px; font-style:italic; color:#999;}
    </style>
</head>
<body>
    <div class="container">
        <div class="search-container">
            <input type="text" id="citySearch" class="search-input" placeholder="Введите название города..." autocomplete="off">
            <div class="search-results" id="searchResults"></div>
            <div class="search-history" id="searchHistory"></div>
        </div>
        
        <div class="widget-container">
            <div class="iframe-wrapper">
                <iframe id="weatherWidget" src="" frameborder="0" scrolling="NO" allowtransparency="true" sandbox="allow-same-origin allow-scripts allow-popups allow-popups-to-escape-sandbox"></iframe>
            </div>
        </div>
        
        <div class="map-widget-container">
            <div class="map-iframe-wrapper">
                <iframe id="mapWidget" src="https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/%D0%BA%D0%B0%D1%80%D1%82%D1%8B/widget/%d0%a1%d0%be%d1%87%d0%b8_%d0%a0%d0%be%d1%81%d1%81%d0%b8%d1%8f_491422?windAnimation=1&gust=1&satellite=1&cloudsAndPrecipitation=1&temperature=1&sunshine=1&extremeForecastIndex=1&geoloc=fixed&tempunit=C&windunit=m%252Fs&lengthunit=metric&zoom=9&autowidth=manu" frameborder="0" scrolling="NO" allowtransparency="true" sandbox="allow-same-origin allow-scripts allow-popups allow-popups-to-escape-sandbox"></iframe>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = "Rn5webjm3JVIDEaK";
        const HISTORY_KEY = "weatherWidgetSearchHistory";
        const LAST_CITY_KEY = "weatherWidgetLastCity";
        const MAX_HISTORY_ITEMS = 10;
        const DEFAULT_CITY = {id:"524901", name:"Москва", country:"Россия", encoded:"%d0%9c%d0%be%d1%81%d0%ba%d0%b2%d0%b0_%d0%a0%d0%be%d1%81%d1%81%d0%b8%d1%8f"};
        const DEFAULT_MAP_CITY = {id:"491422", name:"Сочи", country:"Россия", encoded:"%d0%a1%d0%be%d1%87%d0%b8_%d0%a0%d0%be%d1%81%d1%81%d0%b8%d1%8f"};
        let selectedCity;
        
        const loadHistory = () => JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
        const saveHistory = (history) => localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        
        function addToHistory(city) {
            let history = loadHistory();
            const idx = history.findIndex(i => i.id === city.id || (i.name === city.name && i.country === city.country));
            if (idx !== -1) history.splice(idx, 1);
            history.unshift(city);
            if (history.length > MAX_HISTORY_ITEMS) history = history.slice(0, MAX_HISTORY_ITEMS);
            saveHistory(history);
            displayHistory();
        }
        
        function removeFromHistory(index) {
            const history = loadHistory();
            history.splice(index, 1);
            saveHistory(history);
            displayHistory();
        }
        
        function displayHistory() {
            const history = loadHistory();
            const container = document.getElementById("searchHistory");
            container.innerHTML = '';
            
            if (history.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            history.forEach((city, index) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `<div class="city-info">${city.name}</div><div class="delete-btn">×</div>`;
                
                item.querySelector('.city-info').addEventListener('click', () => {
                    selectCity(city);
                    document.getElementById("searchHistory").style.display = 'none';
                    document.getElementById("citySearch").value = '';
                });
                
                item.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeFromHistory(index);
                });
                
                container.appendChild(item);
            });
        }
        
        async function searchCities(query) {
            if (!query || query.length < 2) return [];
            
            try {
                const url = `https://www.meteoblue.com/ru/server/search/query3?query=${encodeURIComponent(query)}&apikey=${API_KEY}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network error');
                const data = await response.json();
                return data.results || [];
            } catch (error) {
                return [];
            }
        }
        
        function encodeCity(name, country) {
            return encodeURIComponent(`${name}_${country}`).replace(/%/g, '%25');
        }
        
        function displayResults(results) {
            const container = document.getElementById("searchResults");
            container.innerHTML = !results || results.length === 0 ? 
                '<div class="search-result-item">Города не найдены</div>' : '';
            
            if (!results || results.length === 0) {
                container.style.display = 'block';
                return;
            }
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                const adminInfo = result.admin1 ? `, ${result.admin1}` : '';
                
                item.innerHTML = `
                    <span class="city-name">${result.name}</span>
                    <span class="country-name">${result.country}${adminInfo}</span>
                `;
                
                item.addEventListener('click', () => {
                    const city = {
                        id: result.id || result.geonameId || "",
                        name: result.name,
                        country: result.country,
                        lat: result.lat,
                        lon: result.lon,
                        encoded: encodeCity(result.name, result.country),
                        url: result.url || ''
                    };
                    
                    selectCity(city);
                    document.getElementById("searchResults").style.display = 'none';
                    document.getElementById("citySearch").value = '';
                    addToHistory(city);
                });
                
                container.appendChild(item);
            });
            
            container.style.display = 'block';
        }
        
        function selectCity(city) {
            selectedCity = city;
            
            // Сохраняем выбранный город в localStorage
            localStorage.setItem(LAST_CITY_KEY, JSON.stringify(city));
            
            if (city.id) {
                updateWeatherWidget(city);
                updateMapWidget(city);
            } else if (city.lat && city.lon) {
                updateWidgetByCoords(city.lat, city.lon);
                updateMapWidgetByCoords(city.lat, city.lon);
            }
        }
        
        function updateWeatherWidget(city) {
            const useUrl = city.url ? city.url : city.encoded;
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/widget/three/${useUrl}_${city.id}?geoloc=fixed&nocurrent=0&noforecast=0&days=4&tempunit=CELSIUS&windunit=METER_PER_SECOND&layout=image&nolocation=1`;
            document.getElementById("weatherWidget").src = widgetSrc;
        }
        
        function updateMapWidget(city) {
            const useUrl = city.url ? city.url : city.encoded;
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/%D0%BA%D0%B0%D1%80%D1%82%D1%8B/widget/${useUrl}_${city.id}?windAnimation=1&gust=1&satellite=1&cloudsAndPrecipitation=1&temperature=1&sunshine=1&extremeForecastIndex=1&geoloc=fixed&tempunit=C&windunit=m%252Fs&lengthunit=metric&zoom=9&autowidth=manu`;
            document.getElementById("mapWidget").src = widgetSrc;
        }
        
        function updateWidgetByCoords(lat, lon) {
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/widget/three/latlon?lat=${lat}&lon=${lon}&geoloc=fixed&nocurrent=0&noforecast=0&days=4&tempunit=CELSIUS&windunit=METER_PER_SECOND&layout=image&nolocation=1`;
            document.getElementById("weatherWidget").src = widgetSrc;
        }
        
        function updateMapWidgetByCoords(lat, lon) {
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/%D0%BA%D0%B0%D1%80%D1%82%D1%8B/widget/latlon?lat=${lat}&lon=${lon}&windAnimation=1&gust=1&satellite=1&cloudsAndPrecipitation=1&temperature=1&sunshine=1&extremeForecastIndex=1&geoloc=fixed&tempunit=C&windunit=m%252Fs&lengthunit=metric&zoom=9&autowidth=manu`;
            document.getElementById("mapWidget").src = widgetSrc;
        }
        
        function resizeIframes() {
            // Масштабирование первого виджета (прогноз)
            const weatherIframe = document.getElementById("weatherWidget");
            const weatherContainer = document.querySelector(".widget-container");
            const width = weatherContainer.offsetWidth;
            
            const scaleFactor = width / 460;
            weatherIframe.style.transform = `scale(${scaleFactor})`;
            weatherIframe.style.width = `${100 / scaleFactor}%`;
            weatherContainer.style.height = `${600 * scaleFactor}px`;
            
            // Масштабирование второго виджета (карта)
            const mapIframe = document.getElementById("mapWidget");
            const mapContainer = document.querySelector(".map-widget-container");
            
            mapIframe.style.transform = `scale(${scaleFactor})`;
            mapIframe.style.width = `${100 / scaleFactor}%`;
            mapContainer.style.height = `${600 * scaleFactor}px`;
        }
        
        // Дополнительно блокируем стандартные жесты прокрутки документа
        document.addEventListener('touchmove', function(e) {
            // Блокируем только свайп вниз от самого верха страницы
            if (window.scrollY <= 0 && e.touches[0].clientY > 10 && e.touches[0].clientY < 100) {
                e.preventDefault();
            }
        }, { passive: false });
        
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById("citySearch");
            const searchButton = document.getElementById("searchButton");
            const searchResults = document.getElementById("searchResults");
            const searchHistory = document.getElementById("searchHistory");
            
            // Получаем последний выбранный город или используем город по умолчанию (Москва)
            const savedCity = localStorage.getItem(LAST_CITY_KEY);
            selectedCity = savedCity ? JSON.parse(savedCity) : DEFAULT_CITY;
            
            let debounceTimer;
            displayHistory();
            
            searchInput.addEventListener('focus', function() {
                if (searchInput.value.trim() === '') {
                    searchResults.style.display = 'none';
                    if (loadHistory().length > 0) {
                        searchHistory.style.display = 'block';
                    }
                } else if (searchInput.value.trim().length >= 2) {
                    searchHistory.style.display = 'none';
                    searchResults.style.display = 'block';
                }
            });
            
            searchInput.addEventListener('input', function() {
                clearTimeout(debounceTimer);
                
                if (searchInput.value.trim() === '') {
                    searchResults.style.display = 'none';
                    if (loadHistory().length > 0) {
                        searchHistory.style.display = 'block';
                    }
                    return;
                }
                
                searchHistory.style.display = 'none';
                
                debounceTimer = setTimeout(async () => {
                    const query = searchInput.value.trim();
                    if (query.length >= 2) {
                        try {
                            const results = await searchCities(query);
                            displayResults(results);
                        } catch (error) {
                            searchResults.innerHTML = '<div class="search-result-item">Ошибка при поиске</div>';
                            searchResults.style.display = 'block';
                        }
                    } else {
                        searchResults.style.display = 'none';
                    }
                }, 300);
            });
            
            searchInput.addEventListener('blur', function(e) {
                setTimeout(() => {
                    if (!document.activeElement.closest('#searchResults') && 
                        !document.activeElement.closest('#searchHistory')) {
                        searchResults.style.display = 'none';
                        searchHistory.style.display = 'none';
                    }
                }, 150);
            });
            
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && 
                    !searchResults.contains(e.target) && 
                    !searchHistory.contains(e.target)) {
                    searchResults.style.display = 'none';
                    searchHistory.style.display = 'none';
                }
            });
            
            if (searchButton) {
                searchButton.addEventListener('click', async function() {
                    const query = searchInput.value.trim();
                    if (query.length >= 2) {
                        searchResults.innerHTML = '<div class="loading">Загрузка...</div>';
                        searchResults.style.display = 'block';
                        searchHistory.classList.remove('active');
                        
                        try {
                            const results = await searchCities(query);
                            displayResults(results);
                        } catch (error) {
                            searchResults.innerHTML = '<div class="search-result-item">Ошибка при поиске</div>';
                            searchResults.style.display = 'block';
                        }
                    }
                });
            }
            
            // Устанавливаем выбранный или дефолтный город при загрузке
            updateWeatherWidget(selectedCity);
            
            // При инициализации карта показывает Сочи (второй виджет)
            const mapWidget = document.getElementById("mapWidget");
            if (mapWidget.src === "") {
                updateMapWidget(DEFAULT_MAP_CITY);
            }
            
            // Добавляем в историю только если это новый город
            const history = loadHistory();
            if (!history.some(item => item.id === selectedCity.id)) {
                addToHistory(selectedCity);
            }
        });
        
        window.addEventListener('load', resizeIframes);
        window.addEventListener('resize', resizeIframes);
    </script>
</body>
</html>
