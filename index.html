<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Погодный виджет</title>
    <!-- Telegram WebApp Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
    
        ym(101522448, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true
        });
        
        function getParameterByName(name) {
            var url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
        
        window.onload = function() {
            var source = getParameterByName('source') || 'unknown';
            var userId = getParameterByName('user_id') || 'unknown';
            
            ym(101522448, 'reachGoal', 'webapp_open', {
                source: source,
                user_id: userId
            });
            
            // Инициализация Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                // Отключаем возможность закрытия приложения свайпом
                // Устанавливаем параметры viewport для запрета закрытия приложения свайпом
                window.Telegram.WebApp.setViewportSettings({
                    can_be_closed: true,                // Приложение может быть закрыто (кнопкой)
                    disable_swipe_to_close: true,       // Отключаем закрытие свайпом
                    disable_pulling_to_refresh: true    // Отключаем обновление страницы свайпом
                });
                
                // Адаптируем тему приложения
                const tgColorScheme = window.Telegram.WebApp.colorScheme;
                if (tgColorScheme === 'dark') {
                    document.body.classList.add('dark-theme');
                }
                
                // Включаем расширение на весь экран
                window.Telegram.WebApp.expand();
            }
        };
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/101522448" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
    <style>
        html, body {
            overscroll-behavior-y: none; /* Предотвращает свайп браузера для обновления страницы */
            touch-action: pan-x pan-y; /* Разрешаем стандартную прокрутку, но контролируем её в JS */
        }
        body {font-family:Arial,sans-serif; margin:0; padding:10px; background-color:#0F4778; overflow-x:hidden; color:#eee;}
        .container {width:100%; max-width:500px; margin:0 auto; display:flex; flex-direction:column; align-items:center;}
        .search-container {width:100%; margin-bottom:15px; position:relative;}
        .search-input {width:100%; padding:12px; border:1px solid #333; border-radius:8px; font-size:16px; background-color:#87CEEB; color:#333; box-sizing:border-box;}
        .search-input::placeholder {color:#444;}
        .search-results {position:absolute; width:100%; max-height:200px; overflow-y:auto; background-color:rgba(135, 206, 235, 0.6); -webkit-backdrop-filter:blur(2px); backdrop-filter:blur(2px); border:1px solid rgba(51, 51, 51, 0.5); border-radius:0 0 8px 8px; z-index:1000; display:none; box-shadow:0 4px 8px rgba(0,0,0,0.15);}
        .search-result-item {padding:10px; cursor:pointer; border-bottom:1px solid rgba(51, 51, 51, 0.3);}
        .search-result-item:hover {background-color:rgba(135, 206, 235, 0.8);}
        .city-name {font-weight:bold; color:#000; text-shadow: 0px 0px 3px rgba(255, 255, 255, 0.7);}
        .country-name {color:#222; font-size:14px; text-shadow: 0px 0px 3px rgba(255, 255, 255, 0.7);}
        .search-history {width:100%; display:none; background-color:rgba(135, 206, 235, 0.6); -webkit-backdrop-filter:blur(2px); backdrop-filter:blur(2px); border:1px solid rgba(51, 51, 51, 0.5); border-radius:0 0 8px 8px; position:absolute; top:100%; z-index:900; box-shadow:0 4px 8px rgba(0,0,0,0.15);}
        .history-item {padding:8px 10px; cursor:pointer; border-bottom:1px solid rgba(51, 51, 51, 0.3); display:flex; justify-content:space-between; align-items:center; font-size:14px; color:#000; text-shadow: 0px 0px 3px rgba(255, 255, 255, 0.7);}
        .history-item:hover {background-color:rgba(135, 206, 235, 0.95);}
        .city-info {flex-grow:1;}
        .delete-btn {color:#ff5252; cursor:pointer; padding:2px 6px; font-size:14px; border-radius:4px;}
        .delete-btn:hover {background-color:rgba(255,82,82,0.2);}
        
        /* Стили для вкладок */
        .tabs-container {
            display: flex;
            width: 100%;
            margin-bottom: 0; /* Убираем отступ снизу */
            border-radius: 8px 8px 0 0; /* Закругляем только верхние углы */
            overflow: hidden;
        }
        .tab {
            flex: 1;
            padding: 6px 0; /* Уменьшаем высоту вкладок в два раза */
            text-align: center;
            background-color: rgba(135, 206, 235, 0.4);
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            font-size: 12px; /* Уменьшаем размер шрифта для пяти вкладок */
        }
        .tab.active {
            background-color: rgba(135, 206, 235, 0.8);
            color: #003366;
        }
        .tab:first-child {
            border-top-left-radius: 8px;
        }
        .tab:last-child {
            border-top-right-radius: 8px;
        }
        
        .four-day-widget-container {
            width: 100%; 
            display: none; 
            justify-content: center; 
            align-items: flex-start; 
            background-color: #1e1e1e; 
            border-radius: 0 0 8px 8px; /* Закругляем только нижние углы */
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
            overflow-x: auto;
            overflow-y: hidden;
            position: relative; 
            padding: 0; 
            margin-bottom: 15px;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            scrollbar-width: thin;
        }
        
        .seven-day-widget-container {
            width: 100%; 
            display: none; 
            justify-content: center; 
            align-items: flex-start; 
            background-color: #1e1e1e; 
            border-radius: 0 0 8px 8px; /* Закругляем только нижние углы */
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
            overflow-x: auto; /* Добавляем горизонтальную прокрутку */
            overflow-y: hidden; /* Запрещаем вертикальную прокрутку */
            position: relative; 
            padding: 0; 
            margin-bottom: 15px;
            -webkit-overflow-scrolling: touch; /* Плавная прокрутка на iOS */
            scroll-behavior: smooth; /* Плавная прокрутка */
            scrollbar-width: thin; /* Тонкий скроллбар для Firefox */
        }
        
        /* Стили для скроллбара в Chrome/Safari */
        .four-day-widget-container::-webkit-scrollbar,
        .seven-day-widget-container::-webkit-scrollbar {
            height: 6px;
        }
        
        .four-day-widget-container::-webkit-scrollbar-track,
        .seven-day-widget-container::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
        }
        
        .four-day-widget-container::-webkit-scrollbar-thumb,
        .seven-day-widget-container::-webkit-scrollbar-thumb {
            background: rgba(135, 206, 235, 0.5);
            border-radius: 3px;
        }
        
        .four-day-widget-container::-webkit-scrollbar-thumb:hover,
        .seven-day-widget-container::-webkit-scrollbar-thumb:hover {
            background: rgba(135, 206, 235, 0.8);
        }
        
        .iframe-wrapper {width:100%; position:relative; overflow:hidden;}
        iframe {border:none; width:100%; height:620px; transform-origin:0 0; margin:0;}
        
        .satellite-widget-container,
        .precipitation-widget-container,
        .wind-widget-container {
            width: 100%; 
            display: none; 
            justify-content: center; 
            align-items: flex-start; 
            background-color: #1e1e1e; 
            border-radius: 0 0 8px 8px; /* Закругляем только нижние углы */
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
            overflow: hidden; 
            position: relative; 
            padding: 0; 
            margin-bottom: 15px;
        }
        .map-iframe-wrapper {width:100%; position:relative; overflow:hidden;}
        .loading {text-align:center; padding:20px; font-style:italic; color:#999;}
    </style>
</head>
<body>
    <div class="container">
        <div class="search-container">
            <input type="text" id="citySearch" class="search-input" placeholder="Введите название города..." autocomplete="off">
            <div class="search-results" id="searchResults"></div>
            <div class="search-history" id="searchHistory"></div>
        </div>
        
        <div class="tabs-container">
            <div class="tab active" id="fourDayTab">4 дня</div>
            <div class="tab" id="sevenDayTab">7 дней</div>
            <div class="tab" id="satelliteTab">Спутник</div>
            <div class="tab" id="precipitationTab">Осадки</div>
            <div class="tab" id="windTab">Ветер</div>
        </div>
        
        <div class="four-day-widget-container">
            <div class="iframe-wrapper">
                <iframe id="fourDayWidget" src="" frameborder="0" scrolling="NO" allowtransparency="true" sandbox="allow-same-origin allow-scripts allow-popups allow-popups-to-escape-sandbox"></iframe>
            </div>
        </div>
        
        <div class="seven-day-widget-container">
            <div class="iframe-wrapper">
                <iframe id="sevenDayWidget" src="" frameborder="0" scrolling="NO" allowtransparency="true" sandbox="allow-same-origin allow-scripts allow-popups allow-popups-to-escape-sandbox"></iframe>
            </div>
        </div>
        
        <div class="satellite-widget-container">
            <div class="iframe-wrapper">
                <iframe id="satelliteWidget" src="" frameborder="0" scrolling="NO" allowtransparency="true" sandbox="allow-same-origin allow-scripts allow-popups allow-popups-to-escape-sandbox"></iframe>
            </div>
        </div>
        
        <div class="precipitation-widget-container">
            <div class="iframe-wrapper">
                <iframe id="precipitationWidget" src="" frameborder="0" scrolling="NO" allowtransparency="true" sandbox="allow-same-origin allow-scripts allow-popups allow-popups-to-escape-sandbox"></iframe>
            </div>
        </div>
        
        <div class="wind-widget-container">
            <div class="iframe-wrapper">
                <iframe id="windWidget" src="" frameborder="0" scrolling="NO" allowtransparency="true" sandbox="allow-same-origin allow-scripts allow-popups allow-popups-to-escape-sandbox"></iframe>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = "Rn5webjm3JVIDEaK";
        const HISTORY_KEY = "weatherWidgetSearchHistory";
        const LAST_CITY_KEY = "weatherWidgetLastCity";
        const MAX_HISTORY_ITEMS = 10;
        const DEFAULT_CITY = {id:"524901", name:"Москва", country:"Россия", encoded:"%d0%9c%d0%be%d1%81%d0%ba%d0%b2%d0%b0_%d0%a0%d0%be%d1%81%d1%81%d0%b8%d1%8f"};
        let selectedCity;
        
        const loadHistory = () => JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
        const saveHistory = (history) => localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        
        function addToHistory(city) {
            let history = loadHistory();
            const idx = history.findIndex(i => i.id === city.id || (i.name === city.name && i.country === city.country));
            if (idx !== -1) history.splice(idx, 1);
            history.unshift(city);
            if (history.length > MAX_HISTORY_ITEMS) history = history.slice(0, MAX_HISTORY_ITEMS);
            saveHistory(history);
            displayHistory();
        }
        
        function removeFromHistory(index) {
            const history = loadHistory();
            history.splice(index, 1);
            saveHistory(history);
            displayHistory();
        }
        
        function displayHistory() {
            const history = loadHistory();
            const container = document.getElementById("searchHistory");
            container.innerHTML = '';
            
            if (history.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            history.forEach((city, index) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `<div class="city-info">${city.name}</div><div class="delete-btn">×</div>`;
                
                item.querySelector('.city-info').addEventListener('click', () => {
                    selectCity(city);
                    document.getElementById("searchHistory").style.display = 'none';
                    document.getElementById("citySearch").value = '';
                });
                
                item.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeFromHistory(index);
                });
                
                container.appendChild(item);
            });
        }
        
        async function searchCities(query) {
            if (!query || query.length < 2) return [];
            
            try {
                const url = `https://www.meteoblue.com/ru/server/search/query3?query=${encodeURIComponent(query)}&apikey=${API_KEY}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network error');
                const data = await response.json();
                return data.results || [];
            } catch (error) {
                return [];
            }
        }
        
        function encodeCity(name, country) {
            return encodeURIComponent(`${name}_${country}`).replace(/%/g, '%25');
        }
        
        function displayResults(results) {
            const container = document.getElementById("searchResults");
            container.innerHTML = !results || results.length === 0 ? 
                '<div class="search-result-item">Города не найдены</div>' : '';
            
            if (!results || results.length === 0) {
                container.style.display = 'block';
                return;
            }
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                const adminInfo = result.admin1 ? `, ${result.admin1}` : '';
                
                item.innerHTML = `
                    <span class="city-name">${result.name}</span>
                    <span class="country-name">${result.country}${adminInfo}</span>
                `;
                
                item.addEventListener('click', () => {
                    const city = {
                        id: result.id || result.geonameId || "",
                        name: result.name,
                        country: result.country,
                        lat: result.lat,
                        lon: result.lon,
                        encoded: encodeCity(result.name, result.country),
                        url: result.url || ''
                    };
                    
                    selectCity(city);
                    document.getElementById("searchResults").style.display = 'none';
                    document.getElementById("citySearch").value = '';
                    addToHistory(city);
                });
                
                container.appendChild(item);
            });
            
            container.style.display = 'block';
        }
        
        function selectCity(city) {
            selectedCity = city;
            
            // Сохраняем выбранный город в localStorage
            localStorage.setItem(LAST_CITY_KEY, JSON.stringify(city));
            
            if (city.id) {
                updateFourDayWidget(city);
                updateSevenDayWidget(city);
                updateSatelliteWidget(city);
                updatePrecipitationWidget(city);
                updateWindWidget(city);
            } else if (city.lat && city.lon) {
                updateFourDayWidgetByCoords(city.lat, city.lon);
                updateSevenDayWidgetByCoords(city.lat, city.lon);
                updateSatelliteWidgetByCoords(city.lat, city.lon);
                updatePrecipitationWidgetByCoords(city.lat, city.lon);
                updateWindWidgetByCoords(city.lat, city.lon);
            }
        }
        
        function updateFourDayWidget(city) {
            const useUrl = city.url ? city.url : city.encoded;
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/widget/three/${useUrl}_${city.id}?geoloc=fixed&nocurrent=0&noforecast=0&days=4&tempunit=CELSIUS&windunit=METER_PER_SECOND&layout=image`;
            document.getElementById("fourDayWidget").src = widgetSrc;
            console.log("Виджет 4 дня обновлен:", widgetSrc);
        }
        
        function updateFourDayWidgetByCoords(lat, lon) {
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/widget/three/latlon?lat=${lat}&lon=${lon}&geoloc=fixed&nocurrent=0&noforecast=0&days=4&tempunit=CELSIUS&windunit=METER_PER_SECOND&layout=image`;
            document.getElementById("fourDayWidget").src = widgetSrc;
            console.log("Виджет 4 дня по координатам обновлен:", widgetSrc);
        }
        
        function updateSevenDayWidget(city) {
            const useUrl = city.url ? city.url : city.encoded;
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/widget/three/${useUrl}_${city.id}?geoloc=fixed&nocurrent=0&noforecast=0&days=7&tempunit=CELSIUS&windunit=METER_PER_SECOND&layout=image`;
            document.getElementById("sevenDayWidget").src = widgetSrc;
            console.log("Виджет 7 дней обновлен:", widgetSrc);
        }
        
        function updateSevenDayWidgetByCoords(lat, lon) {
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/widget/three/latlon?lat=${lat}&lon=${lon}&geoloc=fixed&nocurrent=0&noforecast=0&days=7&tempunit=CELSIUS&windunit=METER_PER_SECOND&layout=image`;
            document.getElementById("sevenDayWidget").src = widgetSrc;
            console.log("Виджет 7 дней по координатам обновлен:", widgetSrc);
        }
        
        function updateSatelliteWidget(city) {
            const useUrl = city.url ? city.url : city.encoded;
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/%D0%BA%D0%B0%D1%80%D1%82%D1%8B/widget/${useUrl}_${city.id}?windAnimation=0&gust=0&satellite=1&cloudsAndPrecipitation=0&temperature=0&sunshine=0&extremeForecastIndex=0&geoloc=fixed&tempunit=C&windunit=m%252Fs&lengthunit=metric&zoom=5&autowidth=manu`;
            document.getElementById("satelliteWidget").src = widgetSrc;
            console.log("Спутниковый виджет обновлен:", widgetSrc);
        }
        
        function updateSatelliteWidgetByCoords(lat, lon) {
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/%D0%BA%D0%B0%D1%80%D1%82%D1%8B/widget/latlon?lat=${lat}&lon=${lon}&windAnimation=0&gust=0&satellite=1&cloudsAndPrecipitation=0&temperature=0&sunshine=0&extremeForecastIndex=0&geoloc=fixed&tempunit=C&windunit=m%252Fs&lengthunit=metric&zoom=5&autowidth=manu`;
            document.getElementById("satelliteWidget").src = widgetSrc;
            console.log("Спутниковый виджет по координатам обновлен:", widgetSrc);
        }
        
        function updatePrecipitationWidget(city) {
            const useUrl = city.url ? city.url : city.encoded;
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/%D0%BA%D0%B0%D1%80%D1%82%D1%8B/widget/${useUrl}_${city.id}?windAnimation=0&gust=0&satellite=0&cloudsAndPrecipitation=1&temperature=0&sunshine=0&extremeForecastIndex=0&geoloc=fixed&tempunit=C&windunit=m%252Fs&lengthunit=metric&zoom=5&autowidth=manu`;
            document.getElementById("precipitationWidget").src = widgetSrc;
            console.log("Виджет осадков обновлен:", widgetSrc);
        }
        
        function updatePrecipitationWidgetByCoords(lat, lon) {
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/%D0%BA%D0%B0%D1%80%D1%82%D1%8B/widget/latlon?lat=${lat}&lon=${lon}&windAnimation=0&gust=0&satellite=0&cloudsAndPrecipitation=1&temperature=0&sunshine=0&extremeForecastIndex=0&geoloc=fixed&tempunit=C&windunit=m%252Fs&lengthunit=metric&zoom=5&autowidth=manu`;
            document.getElementById("precipitationWidget").src = widgetSrc;
            console.log("Виджет осадков по координатам обновлен:", widgetSrc);
        }
        
        function updateWindWidget(city) {
            const useUrl = city.url ? city.url : city.encoded;
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/%D0%BA%D0%B0%D1%80%D1%82%D1%8B/widget/${useUrl}_${city.id}?windAnimation=1&gust=0&satellite=0&cloudsAndPrecipitation=0&temperature=0&sunshine=0&extremeForecastIndex=0&geoloc=fixed&tempunit=C&windunit=m%252Fs&lengthunit=metric&zoom=8&autowidth=manu`;
            document.getElementById("windWidget").src = widgetSrc;
            console.log("Виджет ветра обновлен:", widgetSrc);
        }
        
        function updateWindWidgetByCoords(lat, lon) {
            const widgetSrc = `https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/%D0%BA%D0%B0%D1%80%D1%82%D1%8B/widget/latlon?lat=${lat}&lon=${lon}&windAnimation=1&gust=0&satellite=0&cloudsAndPrecipitation=0&temperature=0&sunshine=0&extremeForecastIndex=0&geoloc=fixed&tempunit=C&windunit=m%252Fs&lengthunit=metric&zoom=8&autowidth=manu`;
            document.getElementById("windWidget").src = widgetSrc;
            console.log("Виджет ветра по координатам обновлен:", widgetSrc);
        }
        
        function resizeIframes() {
            console.log("Вызвана функция resizeIframes");
            
            // Для 4-дневного прогноза
            const fourDayIframe = document.getElementById("fourDayWidget");
            const fourDayContainer = document.querySelector(".four-day-widget-container");
            if (fourDayIframe && fourDayContainer) {
                const width = fourDayContainer.offsetWidth;
                const heightScaleFactor = width / 460; // Используем тот же коэффициент что и для других виджетов
                const widthScaleFactor = width / 460; // Масштаб по ширине
                
                fourDayIframe.style.transform = `scale(${widthScaleFactor})`;
                fourDayIframe.style.width = `${460}px`; // Фиксированная ширина в px
                fourDayIframe.style.transformOrigin = "0 0"; // Точка трансформации - левый верхний угол
                
                fourDayContainer.style.height = `${592 * heightScaleFactor}px`;
                fourDayIframe.style.height = `${592}px`;
            }
            
            /// Для 7-дневного прогноза
            const sevenDayIframe = document.getElementById("sevenDayWidget");
            const sevenDayContainer = document.querySelector(".seven-day-widget-container");
            if (sevenDayIframe && sevenDayContainer) {
                const width = sevenDayContainer.offsetWidth;
                // Сохраняем полную высоту как у других виджетов (~ 600px)
                const heightScaleFactor = width / 460;
                const widthScaleFactor = width / 805; // Масштаб по ширине (виджет 7 дней шире)
                
                // Применяем масштабирование, которое сохранит полную высоту
                sevenDayIframe.style.transform = `scale(${widthScaleFactor})`;
                sevenDayIframe.style.width = `${805}px`; // Фиксированная ширина в px
                sevenDayIframe.style.transformOrigin = "0 0"; // Точка трансформации - левый верхний угол
                
                // Устанавливаем высоту контейнера такую же, как и у других виджетов
                sevenDayContainer.style.height = `${600 * heightScaleFactor}px`;
                
                // Но сам iframe делаем высоким, чтобы содержимое было видно полностью
                sevenDayIframe.style.height = `${600 / widthScaleFactor * heightScaleFactor}px`;
            }
            
            // Для остальных виджетов применяем стандартное масштабирование
            const containers = [
                { iframe: document.getElementById("satelliteWidget"), container: document.querySelector(".satellite-widget-container") },
                { iframe: document.getElementById("precipitationWidget"), container: document.querySelector(".precipitation-widget-container") },
                { iframe: document.getElementById("windWidget"), container: document.querySelector(".wind-widget-container") }
            ];
            
            containers.forEach(item => {
                if (item.iframe && item.container) {
                    const width = item.container.offsetWidth;
                    const scaleFactor = width / 460;
                    item.iframe.style.transform = `scale(${scaleFactor})`;
                    item.iframe.style.width = `${100 / scaleFactor}%`;
                    item.container.style.height = `${600 * scaleFactor}px`;
                    
                    // Проверка, не пуст ли iframe
                    if (!item.iframe.src || item.iframe.src === "about:blank" || item.iframe.src === "") {
                        console.log("Обнаружен пустой iframe:", item.iframe.id);
                    }
                }
            });
            
            // Проверка, не пусты ли iframe
            const iframesToCheck = [
                { iframe: document.getElementById("fourDayWidget"), update: updateFourDayWidget },
                { iframe: document.getElementById("sevenDayWidget"), update: updateSevenDayWidget }
            ];
            
            iframesToCheck.forEach(item => {
                if (item.iframe && (!item.iframe.src || item.iframe.src === "about:blank" || item.iframe.src === "")) {
                    console.log("Обнаружен пустой iframe, обновляем:", item.iframe.id);
                    if (selectedCity) {
                        item.update(selectedCity);
                    }
                }
            });
        }
        
        // Обработчики вкладок
        function switchToFourDayTab() {
            console.log("Переключение на вкладку 4 дня");
            document.getElementById('fourDayTab').classList.add('active');
            document.getElementById('sevenDayTab').classList.remove('active');
            document.getElementById('satelliteTab').classList.remove('active');
            document.getElementById('precipitationTab').classList.remove('active');
            document.getElementById('windTab').classList.remove('active');
            
            document.querySelector('.four-day-widget-container').style.display = 'flex';
            document.querySelector('.seven-day-widget-container').style.display = 'none';
            document.querySelector('.satellite-widget-container').style.display = 'none';
            document.querySelector('.precipitation-widget-container').style.display = 'none';
            document.querySelector('.wind-widget-container').style.display = 'none';
            
            // Проверим, загружен ли виджет прогноза погоды
            const fourDayWidget = document.getElementById("fourDayWidget");
            if (!fourDayWidget.src || fourDayWidget.src === "about:blank" || fourDayWidget.src === "") {
                console.log("Виджет 4 дня пуст, загружаем снова");
                updateFourDayWidget(selectedCity);
            }
            
            // Принудительно вызываем resizeIframes для корректного отображения
            resizeIframes();
        }
        
        function switchToSevenDayTab() {
            console.log("Переключение на вкладку 7 дней");
            document.getElementById('fourDayTab').classList.remove('active');
            document.getElementById('sevenDayTab').classList.add('active');
            document.getElementById('satelliteTab').classList.remove('active');
            document.getElementById('precipitationTab').classList.remove('active');
            document.getElementById('windTab').classList.remove('active');
            
            document.querySelector('.four-day-widget-container').style.display = 'none';
            document.querySelector('.seven-day-widget-container').style.display = 'flex';
            document.querySelector('.satellite-widget-container').style.display = 'none';
            document.querySelector('.precipitation-widget-container').style.display = 'none';
            document.querySelector('.wind-widget-container').style.display = 'none';
            
            // Проверим, загружен ли виджет прогноза погоды
            const sevenDayWidget = document.getElementById("sevenDayWidget");
            if (!sevenDayWidget.src || sevenDayWidget.src === "about:blank" || sevenDayWidget.src === "") {
                console.log("Виджет 7 дней пуст, загружаем снова");
                updateSevenDayWidget(selectedCity);
            }
            
            // Принудительно вызываем resizeIframes для корректного отображения
            resizeIframes();
        }
        
        function switchToSatelliteTab() {
            console.log("Переключение на вкладку Спутник");
            document.getElementById('fourDayTab').classList.remove('active');
            document.getElementById('sevenDayTab').classList.remove('active');
            document.getElementById('satelliteTab').classList.add('active');
            document.getElementById('precipitationTab').classList.remove('active');
            document.getElementById('windTab').classList.remove('active');
            
            document.querySelector('.four-day-widget-container').style.display = 'none';
            document.querySelector('.seven-day-widget-container').style.display = 'none';
            document.querySelector('.satellite-widget-container').style.display = 'flex';
            document.querySelector('.precipitation-widget-container').style.display = 'none';
            document.querySelector('.wind-widget-container').style.display = 'none';
            
            // Принудительно вызываем resizeIframes для корректного отображения
            resizeIframes();
        }
        
        function switchToPrecipitationTab() {
            console.log("Переключение на вкладку Осадки");
            document.getElementById('fourDayTab').classList.remove('active');
            document.getElementById('sevenDayTab').classList.remove('active');
            document.getElementById('satelliteTab').classList.remove('active');
            document.getElementById('precipitationTab').classList.add('active');
            document.getElementById('windTab').classList.remove('active');
            
            document.querySelector('.four-day-widget-container').style.display = 'none';
            document.querySelector('.seven-day-widget-container').style.display = 'none';
            document.querySelector('.satellite-widget-container').style.display = 'none';
            document.querySelector('.precipitation-widget-container').style.display = 'flex';
            document.querySelector('.wind-widget-container').style.display = 'none';
            
            // Принудительно вызываем resizeIframes для корректного отображения
            resizeIframes();
        }
        
        function switchToWindTab() {
            console.log("Переключение на вкладку Ветер");
            document.getElementById('fourDayTab').classList.remove('active');
            document.getElementById('sevenDayTab').classList.remove('active');
            document.getElementById('satelliteTab').classList.remove('active');
            document.getElementById('precipitationTab').classList.remove('active');
            document.getElementById('windTab').classList.add('active');
            
            document.querySelector('.four-day-widget-container').style.display = 'none';
            document.querySelector('.seven-day-widget-container').style.display = 'none';
            document.querySelector('.satellite-widget-container').style.display = 'none';
            document.querySelector('.precipitation-widget-container').style.display = 'none';
            document.querySelector('.wind-widget-container').style.display = 'flex';
            
            // Принудительно вызываем resizeIframes для корректного отображения
            resizeIframes();
        }
        
        // Добавляем обработчики для сенсорных устройств для лучшей прокрутки
        let touchStartX = 0;
        let scrollLeft = 0;
        
        function setupScrollHandlers() {
            const containers = [
                document.querySelector('.four-day-widget-container'),
                document.querySelector('.seven-day-widget-container')
            ];
            
            containers.forEach(container => {
                if (!container) return;
                
                // Обработчики для сенсорных устройств
                container.addEventListener('touchstart', function(e) {
                    touchStartX = e.targetTouches[0].pageX - container.offsetLeft;
                    scrollLeft = container.scrollLeft;
                }, { passive: true });
                
                container.addEventListener('touchmove', function(e) {
                    if (!touchStartX) return;
                    
                    const touchCurrentX = e.targetTouches[0].pageX - container.offsetLeft;
                    const scrollX = touchCurrentX - touchStartX;
                    container.scrollLeft = scrollLeft - scrollX;
                }, { passive: true });
                
                container.addEventListener('touchend', function(e) {
                    touchStartX = 0;
                }, { passive: true });
                
                // Добавляем обработчик колесика мыши для более естественной прокрутки
                container.addEventListener('wheel', function(e) {
                    if (e.deltaY !== 0) {
                        e.preventDefault();
                        container.scrollLeft += e.deltaY;
                    }
                }, { passive: false });
            });
        }
        
        // Дополнительно блокируем стандартные жесты прокрутки документа
        document.addEventListener('touchmove', function(e) {
            // Блокируем только свайп вниз от самого верха страницы
            if (window.scrollY <= 0 && e.touches[0].clientY > 10 && e.touches[0].clientY < 100) {
                e.preventDefault();
            }
        }, { passive: false });
        
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById("citySearch");
            const searchButton = document.getElementById("searchButton");
            const searchResults = document.getElementById("searchResults");
            const searchHistory = document.getElementById("searchHistory");
            
            // Инициализация вкладок
            document.getElementById('fourDayTab').addEventListener('click', switchToFourDayTab);
            document.getElementById('sevenDayTab').addEventListener('click', switchToSevenDayTab);
            document.getElementById('satelliteTab').addEventListener('click', switchToSatelliteTab);
            document.getElementById('precipitationTab').addEventListener('click', switchToPrecipitationTab);
            document.getElementById('windTab').addEventListener('click', switchToWindTab);
            
            // Получаем последний выбранный город или используем город по умолчанию (Москва)
            const savedCity = localStorage.getItem(LAST_CITY_KEY);
            selectedCity = savedCity ? JSON.parse(savedCity) : DEFAULT_CITY;
            
            let debounceTimer;
            displayHistory();
            
            searchInput.addEventListener('focus', function() {
                if (searchInput.value.trim() === '') {
                    searchResults.style.display = 'none';
                    if (loadHistory().length > 0) {
                        searchHistory.style.display = 'block';
                    }
                } else if (searchInput.value.trim().length >= 2) {
                    searchHistory.style.display = 'none';
                    searchResults.style.display = 'block';
                }
            });
            
            searchInput.addEventListener('input', function() {
                clearTimeout(debounceTimer);
                
                if (searchInput.value.trim() === '') {
                    searchResults.style.display = 'none';
                    if (loadHistory().length > 0) {
                        searchHistory.style.display = 'block';
                    }
                    return;
                }
                
                searchHistory.style.display = 'none';
                
                debounceTimer = setTimeout(async () => {
                    const query = searchInput.value.trim();
                    if (query.length >= 2) {
                        try {
                            const results = await searchCities(query);
                            displayResults(results);
                        } catch (error) {
                            searchResults.innerHTML = '<div class="search-result-item">Ошибка при поиске</div>';
                            searchResults.style.display = 'block';
                        }
                    } else {
                        searchResults.style.display = 'none';
                    }
                }, 300);
            });
            
            searchInput.addEventListener('blur', function(e) {
                setTimeout(() => {
                    if (!document.activeElement.closest('#searchResults') && 
                        !document.activeElement.closest('#searchHistory')) {
                        searchResults.style.display = 'none';
                        searchHistory.style.display = 'none';
                    }
                }, 150);
            });
            
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && 
                    !searchResults.contains(e.target) && 
                    !searchHistory.contains(e.target)) {
                    searchResults.style.display = 'none';
                    searchHistory.style.display = 'none';
                }
            });
            
            if (searchButton) {
                searchButton.addEventListener('click', async function() {
                    const query = searchInput.value.trim();
                    if (query.length >= 2) {
                        searchResults.innerHTML = '<div class="loading">Загрузка...</div>';
                        searchResults.style.display = 'block';
                        searchHistory.classList.remove('active');
                        
                        try {
                            const results = await searchCities(query);
                            displayResults(results);
                        } catch (error) {
                            searchResults.innerHTML = '<div class="search-result-item">Ошибка при поиске</div>';
                            searchResults.style.display = 'block';
                        }
                    }
                });
            }
            
            // Устанавливаем выбранный город при загрузке для всех виджетов
            updateFourDayWidget(selectedCity);
            updateSevenDayWidget(selectedCity);
            updateSatelliteWidget(selectedCity);
            updatePrecipitationWidget(selectedCity);
            updateWindWidget(selectedCity);
            
            // Всегда открываем приложение на вкладке "4 дня"
            switchToFourDayTab();
            
            // Добавляем в историю только если это новый город
            const history = loadHistory();
            if (!history.some(item => item.id === selectedCity.id)) {
                addToHistory(selectedCity);
            }
        });
        
        window.addEventListener('load', function() {
            console.log("Страница полностью загружена");
            // Повторно назначаем обработчики событий для вкладок после полной загрузки
            document.getElementById('fourDayTab').addEventListener('click', switchToFourDayTab);
            document.getElementById('sevenDayTab').addEventListener('click', switchToSevenDayTab);
            document.getElementById('satelliteTab').addEventListener('click', switchToSatelliteTab);
            document.getElementById('precipitationTab').addEventListener('click', switchToPrecipitationTab);
            document.getElementById('windTab').addEventListener('click', switchToWindTab);
            
            // Повторно инициализируем виджеты
            if (selectedCity) {
                console.log("Обновляем виджеты для города:", selectedCity.name);
                updateFourDayWidget(selectedCity);
                updateSevenDayWidget(selectedCity);
                updateSatelliteWidget(selectedCity);
                updatePrecipitationWidget(selectedCity);
                updateWindWidget(selectedCity);
            }
            
            // Настраиваем обработчики прокрутки
            setupScrollHandlers();
            
            resizeIframes();
            
            // Проверим, что все iframe элементы существуют
            console.log("Проверка iframe элементов:");
            console.log("fourDayWidget:", document.getElementById("fourDayWidget"));
            console.log("sevenDayWidget:", document.getElementById("sevenDayWidget"));
            console.log("satelliteWidget:", document.getElementById("satelliteWidget"));
            console.log("precipitationWidget:", document.getElementById("precipitationWidget"));
            console.log("windWidget:", document.getElementById("windWidget"));
        });
        window.addEventListener('resize', resizeIframes);
    </script>
</body>
</html>
